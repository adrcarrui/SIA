{# templates/main/index.html #}
{% extends "base.html" %}

{% block content %}
<h2>Dashboard</h2>

{# FILA DE 4/5 CUADRADOS #}
<div class="row mb-4 g-3 row-cols-1 row-cols-sm-2 row-cols-lg-3 row-cols-xl-5">

  {# 1. Users #}
  <div class="col">
    <div class="card text-white border-0 stat-card stat-card-users bg-users">
      <div class="card-body position-relative p-3">
        <div class="fs-3 fw-bold">
          {{ "{:,}".format(total_users or 0) }}
        </div>
        <div class="small">Users</div>

        <div class="stat-card-footer mt-3 pt-2 text-center">
          <a href="{{ url_for('users.index') }}"
             class="small text-white text-decoration-none d-inline-flex align-items-center gap-1">
            <span>view all</span>
            <i class="bi bi-arrow-right-circle"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  {# 2. Devices #}
  <div class="col">
    <div class="card border-0 stat-card stat-card-licenses bg-devices">
      <div class="card-body position-relative p-3 text-dark">
        <div class="fw-semibold text-center mb-2">
          <h4 class="mb-0">Devices</h4>
        </div>

        {% if device_stats %}
          <div class="mt-2">
            <table
              class="table table-sm align-middle mb-0 small"
              style="--bs-table-bg: transparent;"
            >
              <thead>
                <tr>
                  <th class="fw-normal text-muted"></th>
                  {% for row in device_stats %}
                    {% set tkey = row.type or "Unknown" %}
                    {% set tcolor = {
                      'vending': 'primary',
                      'canteen': 'success',
                      'instructor': 'warning',
                      'guest': 'secondary'
                    }.get(tkey, 'light') %}
                    <th class="fs-6 text-center fw-normal">
                      <span class="badge text-bg-{{ tcolor }}">
                        {{ tkey }}
                      </span>
                    </th>
                  {% endfor %}
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="fw-semibold text-center">Loan</td>
                  {% for row in device_stats %}
                    <td class="text-center text-muted">
                      <span>
                        {{ row.assigned }}/{{ row.total }}
                      </span>
                    </td>
                  {% endfor %}
                </tr>
                <tr>
                  <td class="fw-semibold text-center">% Use</td>
                  {% for row in device_stats %}
                    <td class="text-center fw-semibold text-muted">
                      {{ row.ratio|round(0, 'floor') }}%
                    </td>
                  {% endfor %}
                </tr>
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="text-center mb-0 text-muted">
            No devices registered.
          </p>
        {% endif %}

        <div class="stat-card-footer mt-3 pt-2 text-center">
          <a href="{{ url_for('devices.index') }}"
             class="small text-decoration-none d-inline-flex align-items-center gap-1 text-dark">
            <span>view all</span>
            <i class="bi bi-arrow-right-circle"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  {# 3. Alerts (resumen) #}
  <div class="col">
    <div class="card border-0 stat-card stat-card-licenses bg-alerts">
      <div class="card-body position-relative p-3 text-dark">
        <div class="fw-semibold text-center mb-2">
          <h4 class="mb-0">Alerts</h4>
          <div class="stat-card-footer mt-3 pt-2 text-center">
            <a href="{{ url_for('devices.index') }}"
               class="small text-decoration-none d-inline-flex align-items-center gap-1 text-dark">
              <span>view all</span>
              <i class="bi bi-arrow-right-circle"></i>
            </a>
          </div>
        </div>
      </div>
    </div>
  </div>

  {# 4. Courses #}
  <div class="col">
    <div class="card text-white border-0 stat-card stat-card-accessories bg-courses">
      <div class="card-body position-relative p-3">
        <div class="fs-3 fw-bold">{{ "{:,}".format(total_courses or 0) }}</div>
        <div class="small">Courses</div>

        <div class="stat-card-footer mt-3 pt-2 text-center">
          <a href="{{ url_for('courses.index') }}"
             class="small text-white text-decoration-none d-inline-flex align-items-center gap-1">
            <span>view all</span>
            <i class="bi bi-arrow-right-circle"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  {# 5. Assignments #}
  <div class="col">
    <div class="card text-white border-0 stat-card stat-card-components bg-assignments">
      <div class="card-body position-relative p-3">
        <div class="fs-3 fw-bold">{{ "{:,}".format(total_assignments or 0) }}</div>
        <div class="small">Assignments</div>

        <div class="stat-card-footer mt-3 pt-2 text-center">
          <a href="{{ url_for('assignments.index') }}"
             class="small text-white text-decoration-none d-inline-flex align-items-center gap-1">
            <span>view all</span>
            <i class="bi bi-arrow-right-circle"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

  {# 6. Movements #}
  <div class="col">
    <div class="card text-white border-0 stat-card stat-card-people bg-movements">
      <div class="card-body position-relative p-3">
        <div class="fs-3 fw-bold">{{ "{:,}".format(total_movements or 0) }}</div>
        <div class="small">Movements</div>

        <div class="stat-card-footer mt-3 pt-2 text-center">
          <a href="{{ url_for('movements.index') }}"
             class="small text-white text-decoration-none d-inline-flex align-items-center gap-1">
            <span>view all</span>
            <i class="bi bi-arrow-right-circle"></i>
          </a>
        </div>
      </div>
    </div>
  </div>

</div>

{# FILA PRINCIPAL: CALENDARIO + ALERTAS #}
<div class="container-fluid py-3">
  <div class="row">
    <!-- Columna calendario -->
    <div class="col-lg-8 mb-3">
      <h2 class="mb-3">Course calendar</h2>
      <div id="calendar" style="min-height: 500px;"></div>
    </div>


<!-- Modal único para ver detalles de curso -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Course details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="courseModalBody">
        <!-- Aquí se cargará el fragmento del curso -->
        <div class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<h5 class="mt-3">Cards vs trainees</h5>
  <div class="table-responsive">
    <table class="table table-sm table-bordered align-middle mb-0">
      <thead class="table-light">
        <tr class="text-center">
          <th>Course</th>
          <th>Assigned</th>
          <th>Trainees</th>
          <th>Δ</th>
        </tr>
      </thead>
      <tbody>
        {% if cards_alerts %}
          {% for a in cards_alerts %}
            {% set c = a.course %}
            <tr class="text-center
                       {% if a.type == 'missing' %}table-warning
                       {% elif a.type == 'extra' %}table-danger
                       {% endif %}">
              <td class="text-start">
                <a href="{{ url_for('courses.detail', course_id=c.id) }}">
                  {{ c.name or c.course or ('Course #' ~ c.id) }}
                </a>
              </td>
              <td>{{ a.assigned }}</td>
              <td>{{ a.trainees }}</td>
              <td>
                {% if a.type == 'missing' %}
                  -{{ a.diff }}
                {% else %}
                  +{{ -a.diff }}
                {% endif %}
              </td>
            </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="text-center text-muted small">
              No mismatches between cards and trainees.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Función común para cargar el fragmento de detalle en el modal
    function loadCourseDetail(url) {
      const modalEl = document.getElementById('courseModal');
      const modalBody = document.getElementById('courseModalBody');
      if (!modalEl || !modalBody) {
        console.error("Course modal not found");
        return;
      }

      modalBody.innerHTML = `
        <div class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;

      fetch(url)
        .then(resp => {
          if (!resp.ok) {
            throw new Error("HTTP " + resp.status);
          }
          return resp.text();
        })
        .then(html => {
          modalBody.innerHTML = html;
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        })
        .catch(err => {
          console.error(err);
          modalBody.innerHTML = `
            <div class="alert alert-danger">
              Error loading course details.
            </div>
          `;
          const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
          modal.show();
        });
    }

    // FullCalendar en el dashboard
    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');
      if (!calendarEl) {
        console.error("Dashboard: #calendar not found");
        return;
      }

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        locale: 'en',
        firstDay: 1,
        height: 'auto',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
        },
        dayMaxEvents: true,
        events: "{{ url_for('courses.api_calendar_events') }}",

        eventClick: function (info) {
          const detailUrl = info.event.extendedProps.detail_url;
          if (detailUrl) {
            info.jsEvent.preventDefault();
            loadCourseDetail(detailUrl);
          } else if (info.event.extendedProps.course_url) {
            // fallback por si algún evento no tiene detail_url
            window.location.href = info.event.extendedProps.course_url;
          }
        }
      });

      calendar.render();
    });

    // Modal de detalles de curso (overdue) - reutiliza la misma función
    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-bs-target="#courseModal"][data-url]');
      if (!btn) return;

      e.preventDefault();
      const url = btn.dataset.url;
      if (url) {
        loadCourseDetail(url);
      }
    });
  </script>
{% endblock %}
