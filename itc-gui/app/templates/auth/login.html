{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-center align-items-center" style="min-height: calc(100vh - 56px);">
  <div class="container" style="max-width: 480px;">
    <div class="card shadow-sm">
      <div class="card-body">

        <h2 class="h4 mb-3 text-center">Login</h2>

        <div class="mb-4 text-center">
          <div class="display-4 mb-2">üì°</div>
          <p class="text-muted mb-1" id="nfc-message">
            Bring your NFC card close to the reader to log in‚Ä¶
          </p>
          <p class="small text-muted">
            Reading is performed automatically, without pressing any button.
          </p>
          <div id="nfc-error" class="small text-danger mt-1"></div>
        </div>

        <hr>

        <!-- Classic login as an alternative -->
        <form method="post" action="{{ url_for('auth.login') }}">
          <div class="mb-3">
            <label class="form-label">Username or email</label>
            <input type="text"
                   name="username"
                   class="form-control"
                   required
                   autocomplete="username"
                   oninvalid="this.setCustomValidity('This field is required')"
                   oninput="this.setCustomValidity('')">
          </div>

          <div class="mb-3">
            <label class="form-label">Password</label>
            <input type="password"
                   name="password"
                   class="form-control"
                   required
                   autocomplete="current-password"
                   oninvalid="this.setCustomValidity('This field is required')"
                   oninput="this.setCustomValidity('')">
          </div>

          <button type="submit" class="btn btn-outline-secondary w-100">
            Login
          </button>
        </form>

      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const msg   = document.getElementById('nfc-message');
  const err   = document.getElementById('nfc-error');

  let stopPolling = false;

  async function pollNFC() {
    if (stopPolling) return;

    try {
      const resp = await fetch("{{ url_for('auth.nfc_login') }}", {
        method: "POST",
        headers: { "X-Requested-With": "XMLHttpRequest" }
      });

      const data = await resp.json().catch(() => ({}));

      if (data.success) {
        msg.textContent = 'Tarjeta reconocida. Iniciando sesi√≥n...';
        err.textContent = '';
        stopPolling = true;
        const nextUrl = data.next || "{{ url_for('main.index') }}";
        window.location.href = nextUrl;
        return;
      }

      // Manejo seg√∫n raz√≥n
      if (data.reason === 'no_card') {
        err.textContent = '';
      } else if (data.reason === 'unknown_uid') {
        err.textContent = data.error || 'Tarjeta no reconocida.';
      } else if (data.reason === 'nfc_unavailable') {
        err.textContent = data.error || 'NFC no disponible en el servidor.';
      } else if (data.reason === 'reader_error') {
        err.textContent = data.error || 'Error NFC reader.';
      } else {
        err.textContent = 'No se ha podido iniciar sesi√≥n con la tarjeta.';
      }

    } catch (e) {
      err.textContent = 'Error de comunicaci√≥n con el servidor.';
    } finally {
      if (!stopPolling) {
        setTimeout(pollNFC, 1000);
      }
    }
  }

  // Arrancamos el bucle de lectura autom√°tica
  pollNFC();
});
</script>

{% endblock %}
