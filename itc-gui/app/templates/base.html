<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page_title or "TCO GUI" }}</title>
  <link href="{{ url_for('static', filename='vendor/bootstrap/bootstrap.min.css') }}" 
      rel="stylesheet">
  <!--<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">-->
  <link href="{{ url_for('static', filename='css/app.css') }}" rel="stylesheet">
  <style>
    .bg-content {
      background-color: #ffffff; /* azul claro agradable a la vista */
      min-height: 100vh; /* asegura que cubra toda la pantalla */
    }
  </style>
</head>
<body>
  <script>
    (function () {
      try {
        if (localStorage.getItem('itcSidebarCollapsed') === "1") {
          document.body.classList.add('sidebar-collapsed');
        }
      } catch (e) {}
    })();
  </script>
  <div class="d-flex"><!-- contenedor principal: sidebar + contenido -->

    {% if not hide_sidebar %}
    <!-- Sidebar (men√∫) -->
      <nav id="sidebar" class="sidebar bg-body-tertiary border-end">
        <div class="p-3">

          <ul class="nav nav-pills flex-column mb-2">
            <!-- Bot√≥n para plegar/desplegar, alineado con el resto -->
            <li class="nav-item mb-2">
              <button id="btn-toggle-sidebar"
                      type="button"
                      class="nav-link d-flex align-items-center gap-2"
                      aria-controls="sidebar"
                      aria-expanded="true"
                      aria-label="Mostrar/ocultar men√∫">
                <span class="icon" aria-hidden="true">‚ò∞</span>
              </button>
            </li>
          <!-- Dashboard -->
          <li class="nav-item">
            <a href="{{ url_for('main.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if request.endpoint == 'main.index' else '' }}"
               title="Dashboard">
              <span class="icon" aria-hidden="true">üß≠</span>
              <span class="label">Dashboard</span>
            </a>
          </li>

          <!-- Users -->
          <li class="nav-item">
            <a href="{{ url_for('users.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if (request.endpoint and request.endpoint.startswith('users.')) else '' }}"
               title="Users">
              <span class="icon" aria-hidden="true">üë•</span>
              <span class="label">Users</span>
            </a>
          </li>

          <!-- Devices (placeholder) -->
          <li class="nav-item">
            <a href="{{ url_for('devices.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if (request.endpoint and request.endpoint.startswith('devices.')) else '' }}"
               title="Devices">
              <span class="icon" aria-hidden="true">üñ•Ô∏è</span>
              <span class="label">Devices</span>
            </a>
          </li>

          <!-- Courses -->
          <li class="nav-item">
            <a href="{{ url_for('courses.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if (request.endpoint and request.endpoint.startswith('courses.')) else '' }}"
               title="Courses">
              <span class="icon" aria-hidden="true">üéì</span>
              <span class="label">Courses</span>
            </a>
          </li>

          <!-- Audit -->
          <li class="nav-item">
            <a href="{{ url_for('movements.index') }}"
              class="nav-link d-flex align-items-center gap-2 {{ 'active' if request.endpoint and request.endpoint.startswith('movements.') else '' }}"
              title="Movements">
              <span class="icon" aria-hidden="true">üìà</span>
              <span class="label">Movements</span>
            </a>
          </li>

          <!-- Assigns -->
          <li class="nav-item">
            <a href="{{ url_for('assignments.index') }}"
              class="nav-link d-flex align-items-center gap-2"
              title="Assigns">
              <span class="icon" aria-hidden="true">üîó</span>
              <span class="label">Assignments</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
    {% endif %}

    <!-- Contenido principal -->
    <!-- AQU√ç EL CAMBIO: quitar bg-contenty y poner bg-content -->
    <main class="flex-grow-1 bg-content">
      <header id="topbar" class="navbar navbar-expand bg-body border-bottom sticky-top">
        <div class="container-fluid">
          <!-- Izquierda: t√≠tulo -->
          <h1 class="navbar-brand fs-6 mb-0">TCO GUI</h1>

          <!-- Derecha: reloj + usuario + logout -->
          <div class="d-flex align-items-center gap-3 ms-auto">
            <span id="clock" class="text-secondary small" aria-label="Hora actual"></span>

            <div class="d-flex align-items-center text-truncate">
              <span class="me-2" aria-hidden="true">üë§</span>
              <span class="fw-medium text-truncate" style="max-width:14rem;">
                {{ (current_user.name or current_user.username or current_user.email) if current_user.is_authenticated else 'Invitado' }}
              </span>
            </div>

            <div class="dropdown">
              <button id="btn-options"
                      class="btn btn-sm btn-outline-secondary"
                      data-bs-toggle="dropdown"
                      aria-expanded="false"
                      aria-label="Opciones">‚ãÆ</button>
              <ul class="dropdown-menu dropdown-menu-end">
                <li><span class="dropdown-item-text">Opciones</span></li>
              </ul>
            </div>

            <!-- Logout -->
            <a href="{{ url_for('auth.logout') }}" class="btn btn-light" title="Logout">‚û°Ô∏è</a>
          </div>
        </div>
      </header>

      <section class="p-4">
        {% block content %}
          {% block default_content %}
          <div class="container py-3">
            <div class="row">
              <!-- IZQUIERDA: calendario -->
              <div class="col-lg-9 mb-3">
                <h2 class="mb-3">Course calendar</h2>

                <div id="calendar-2w" class="cal2w">
                  <div class="cal2w-head" id="cal2w-head"></div>
                  <div class="cal2w-grid" id="cal2w-grid"></div>
                </div>
              </div>

              <!-- DERECHA: tabla de alertas -->
              <div class="col-lg-3 mb-3">
                <table class="table">
                  <thead>
                    <tr>
                      <th scope="col">#</th>
                      <th scope="col">First</th>
                      <th scope="col">Last</th>
                      <th scope="col">Handle</th>
                    </tr>
                  </thead>
                  <tbody>
                    <tr>
                      <th scope="row">1</th>
                      <td>Mark</td>
                      <td>Otto</td>
                      <td>@mdo</td>
                    </tr>
                    <tr>
                      <th scope="row">2</th>
                      <td>Jacob</td>
                      <td>Thornton</td>
                      <td>@fat</td>
                    </tr>
                    <tr>
                      <th scope="row">3</th>
                      <td>John</td>
                      <td>Doe</td>
                      <td>@social</td>
                    </tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
          {% endblock %}
        {% endblock %}
      </section>
    </main>
  </div><!-- /d-flex -->

  {% if reset_sidebar %}
  <script>
    try { localStorage.setItem('itcSidebarCollapsed','0'); } catch(e){}
  </script>
  {% endif %}

  <!-- Script: reloj -->
  <script>
    (function(){
      const el = document.getElementById('clock');
      if (!el) return;
      function tick(){
        try {
          const now = new Date();
          el.textContent = now.toLocaleString('es-ES', {
            hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
        } catch(e){}
      }
      tick();
      setInterval(tick, 1000);
    })();
  </script>

  <!-- Script: sidebar -->
  <script>
    (function () {
      const BODY = document.body;
      const SIDEBAR = document.getElementById('sidebar');
      const KEY  = "itcSidebarCollapsed";
      const btn  = document.getElementById('btn-toggle-sidebar');

      const collapsed = localStorage.getItem(KEY) === "1";
      if (collapsed) BODY.classList.add('sidebar-collapsed');
      if (SIDEBAR) SIDEBAR.setAttribute('aria-hidden', collapsed ? 'true' : 'false');
      if (btn) btn.setAttribute('aria-expanded', (!collapsed).toString());

      function toggleSidebar() {
        BODY.classList.toggle('sidebar-collapsed');
        const isCollapsed = BODY.classList.contains('sidebar-collapsed');
        localStorage.setItem(KEY, isCollapsed ? "1" : "0");
        if (SIDEBAR) SIDEBAR.setAttribute('aria-hidden', isCollapsed ? 'true' : 'false');
        if (btn) btn.setAttribute('aria-expanded', (!isCollapsed).toString());
      }
      if (btn) btn.addEventListener('click', toggleSidebar);
    })();
  </script>

  <!-- Script: calendario 2 semanas -->
<script>
  (function(){
    const DAY_LETTERS = {1:'L', 2:'M', 3:'X', 4:'J', 5:'V'};
    const fmt = (d) => d.toLocaleDateString('es-ES', { day:'2-digit', month:'2-digit' });
    const isWeekend = (d) => {
      const k = d.getDay();
      return k === 0 || k === 6;
    };
    const iso = (d) => {
      const z = (n) => String(n).padStart(2, '0');
      return d.getFullYear() + '-' + z(d.getMonth()+1) + '-' + z(d.getDate());
    };

    function genWorkdaysFromToday(){
      const res = [];
      let d = new Date();
      d.setHours(0,0,0,0);
      const WORKDAYS_TO_SHOW = 14;
      while(res.length < WORKDAYS_TO_SHOW){
        if(!isWeekend(d)){
          res.push(new Date(d));
        }
        d.setDate(d.getDate() + 1);
      }
      return res;
    }

    function renderHeaders(days){
      const head = document.getElementById('cal2w-head');
      if (!head) return;
      head.innerHTML = '';
      for(let i=0; i<5; i++){
        const div = document.createElement('div');
        div.className = 'hcell';
        head.appendChild(div);
      }
    }

    function renderGrid(days){
      const grid = document.getElementById('cal2w-grid');
      if (!grid) return;
      grid.innerHTML = '';

      days.forEach((d, idx) => {
        const cell = document.createElement('div');
        cell.className = 'day';
        cell.setAttribute('data-idx', idx);
        cell.setAttribute('data-date', iso(d));

        const head = document.createElement('div');
        head.className = 'date';
        head.textContent = fmt(d);

        const meta = document.createElement('div');
        meta.className = 'meta';
        meta.textContent = d.toLocaleDateString('es-ES', { weekday:'long' });

        const content = document.createElement('div');
        content.className = 'content flex-grow-1';

        cell.appendChild(head);
        cell.appendChild(meta);
        cell.appendChild(content);
        grid.appendChild(cell);
      });
    }

    function statusClass(status) {
      const base = 'badge d-block text-start mb-1 ';

      if (!status) {
        return base + 'bg-secondary-subtle text-secondary-emphasis';
      }

      const s = String(status).toLowerCase();

      if (s === 'planned') {
        return base + 'bg-warning-subtle text-warning-emphasis';
      }

      if (s === 'active' || s === 'running') {
        return base + 'bg-success-subtle text-success-emphasis';
      }

      if (s === 'finished' || s === 'done') {
        return base + 'bg-secondary-subtle text-secondary-emphasis';
      }

      if (s === 'cancelled' || s === 'canceled' || s.includes('cancel')) {
        return base + 'bg-danger-subtle text-danger-emphasis';
      }

      return base + 'bg-light text-body';
    }

    // Pintar cursos en el calendario; cada curso ser√° clicable (.course-link)
    function renderCourses(days, courses) {
      const grid = document.getElementById('cal2w-grid');
      if (!grid) return;

      days.forEach(d => {
        const dIso = iso(d);
        const cell = grid.querySelector('.day[data-date="' + dIso + '"]');
        if (!cell) return;
        const content = cell.querySelector('.content');
        if (!content) return;
        content.innerHTML = '';

        (courses || []).forEach(c => {
          const start = c.start_date;
          const end   = c.end_date || c.start_date;
          if (dIso >= start && dIso <= end) {
            const link = document.createElement('a');
            link.className = statusClass(c.status) + " text-decoration-none d-block course-link";
            link.href = "#";
            link.dataset.detailUrl = c.detail_url;   // viene en el JSON
            link.title = "Ver detalle del curso";

            let label = c.name || ('Curso #' + c.id);
            if (c.trainees !== null && c.trainees !== undefined && c.trainees !== "") {
              label += " (" + c.trainees + ")";
            }
            link.textContent = label;

            content.appendChild(link);
          }
        });
      });
    }

    function loadCourses(days) {
      if (!days || !days.length) return;
      const from = iso(days[0]);
      const to   = iso(days[days.length - 1]);

      fetch("{{ url_for('courses.calendar_data') }}?from=" + from + "&to=" + to, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(r => r.json())
      .then(data => {
        console.log("Cursos para calendario:", data);
        renderCourses(days, data);
      })
      .catch(err => {
        console.error("Error cargando cursos para el calendario:", err);
      });
    }

    const days = genWorkdaysFromToday();
    renderHeaders(days);
    renderGrid(days);
    loadCourses(days);

    // Recalcular a medianoche
    const msUntilMidnight = (() => {
      const t = new Date();
      const n = new Date(t);
      n.setHours(24,0,0,0);
      return n - t;
    })();

    setTimeout(() => {
      const d2 = genWorkdaysFromToday();
      renderHeaders(d2);
      renderGrid(d2);
      loadCourses(d2);
    }, msUntilMidnight + 1000);

    // Clic en curso ‚Üí cargar fragmento y abrir modal
    document.addEventListener('click', function (ev) {
      const link = ev.target.closest('.course-link');
      if (!link) return;

      ev.preventDefault();

      const url = link.dataset.detailUrl;
      if (!url) return;

      const modalEl = document.getElementById('courseDetailModal');
      const bodyEl  = document.getElementById('courseDetailBody');
      if (!modalEl || !bodyEl) return;

      bodyEl.innerHTML = '<div class="text-center text-muted py-3">Loading...</div>';

      fetch(url, { headers: { "X-Requested-With": "XMLHttpRequest" } })
      .then(r => {
        if (!r.ok) throw new Error("HTTP " + r.status);
        return r.text();
      })
      .then(html => {
        bodyEl.innerHTML = html;
        console.log("Mostrando modal de curso:", url);
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      })
      .catch(err => {
        console.error(err);
        bodyEl.innerHTML = '<div class="text-danger">Error loading course detail.</div>';
        const modal = bootstrap.Modal.getOrCreateInstance(modalEl);
        modal.show();
      });
    });
  })();
</script>


<script src="{{ url_for('static', filename='vendor/bootstrap/bootstrap.bundle.min.js') }}"></script>

<!-- Modal detalle de curso -->
<div class="modal fade" id="courseDetailModal" tabindex="-1" aria-labelledby="courseDetailLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="courseDetailLabel">Course detail</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
      </div>
      <div class="modal-body" id="courseDetailBody">
        <!-- Aqu√≠ cargaremos el contenido por AJAX -->
        <div class="text-center text-muted py-3">
          Loading...
        </div>
      </div>
    </div>
  </div>
</div>
<script src="{{ url_for('static', filename='vendor/bootstrap/bootstrap.bundle.min.js') }}"></script>
</body>
</html>
