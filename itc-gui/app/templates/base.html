<!doctype html>
<html lang="es" data-bs-theme="light">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>{{ page_title or "TCO GUI" }}</title>

  <!-- CSS Bootstrap -->
  <link href="{{ url_for('static', filename='vendor/bootstrap/bootstrap.min.css') }}" rel="stylesheet">

  <!-- CSS app -->
  <link href="{{ url_for('static', filename='css/app.css') }}" rel="stylesheet">

  <link rel="stylesheet" href="{{ url_for('static', filename='vendor/fullcalendar/main.min.css') }}">

  <style>
    .bg-content {
      background-color: #ffffff;
      min-height: 100vh;
    }
  </style>
</head>
<body>
  <script>
    (function () {
      try {
        if (localStorage.getItem('itcSidebarCollapsed') === "1") {
          document.body.classList.add('sidebar-collapsed');
        }
      } catch (e) {}
    })();
  </script>

  <div class="d-flex"><!-- contenedor principal: sidebar + contenido -->

    {% if not hide_sidebar %}
    <!-- Sidebar (men√∫) -->
    <nav id="sidebar" class="sidebar bg-body-tertiary border-end">
      <div class="p-3">
        <ul class="nav nav-pills flex-column mb-2">
          <!-- Bot√≥n para plegar/desplegar -->
          <li class="nav-item mb-2">
            <button id="btn-toggle-sidebar"
                    type="button"
                    class="nav-link d-flex align-items-center gap-2"
                    aria-controls="sidebar"
                    aria-expanded="true"
                    aria-label="Mostrar/ocultar men√∫">
              <span class="icon" aria-hidden="true">‚ò∞</span>
            </button>
          </li>

          <!-- Dashboard -->
          <li class="nav-item">
            <a href="{{ url_for('main.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if request.endpoint == 'main.index' else '' }}"
               title="Dashboard">
              <span class="icon" aria-hidden="true">üß≠</span>
              <span class="label">Dashboard</span>
            </a>
          </li>

          <!-- Users -->
          <li class="nav-item">
            <a href="{{ url_for('users.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if (request.endpoint and request.endpoint.startswith('users.')) else '' }}"
               title="Users">
              <span class="icon" aria-hidden="true">üë•</span>
              <span class="label">Users</span>
            </a>
          </li>

          <!-- Devices -->
          <li class="nav-item">
            <a href="{{ url_for('devices.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if (request.endpoint and request.endpoint.startswith('devices.')) else '' }}"
               title="Devices">
              <span class="icon" aria-hidden="true">üñ•Ô∏è</span>
              <span class="label">Devices</span>
            </a>
          </li>

          <!-- Courses -->
          <li class="nav-item">
            <a href="{{ url_for('courses.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if (request.endpoint and request.endpoint.startswith('courses.')) else '' }}"
               title="Courses">
              <span class="icon" aria-hidden="true">üéì</span>
              <span class="label">Courses</span>
            </a>
          </li>

          <!-- Movements -->
          <li class="nav-item">
            <a href="{{ url_for('movements.index') }}"
               class="nav-link d-flex align-items-center gap-2 {{ 'active' if request.endpoint and request.endpoint.startswith('movements.') else '' }}"
               title="Movements">
              <span class="icon" aria-hidden="true">üìà</span>
              <span class="label">Movements</span>
            </a>
          </li>

          <!-- Assignments -->
          <li class="nav-item">
            <a href="{{ url_for('assignments.index') }}"
               class="nav-link d-flex align-items-center gap-2"
               title="Assignments">
              <span class="icon" aria-hidden="true">üîó</span>
              <span class="label">Assignments</span>
            </a>
          </li>
        </ul>
      </div>
    </nav>
    {% endif %}

    <!-- Contenido principal -->
    <main class="flex-grow-1 bg-content">
      {% if not hide_topbar %}
      <header id="topbar" class="navbar navbar-expand bg-body border-bottom sticky-top">
        <div class="container-fluid">
          <!-- Izquierda: t√≠tulo -->
          <h1 class="navbar-brand fs-6 mb-0">TCO GUI</h1>

          <!-- Derecha: reloj + usuario + logout -->
          <div class="d-flex align-items-center gap-3 ms-auto">
            <span id="clock" class="text-secondary small" aria-label="Hora actual"></span>

            <div class="d-flex align-items-center text-truncate">
              <span class="me-2" aria-hidden="true">üë§</span>
              <span class="fw-medium text-truncate" style="max-width:14rem;">
                {{ (current_user.name or current_user.username or current_user.email) if current_user.is_authenticated else 'Invitado' }}
              </span>
            </div>

            <!-- Logout -->
            <a href="{{ url_for('auth.logout') }}" class="btn btn-light" title="Logout">‚û°Ô∏è</a>
          </div>
        </div>
      </header>
      {% endif %}

      <section class="p-4">
        {% block content %}
        {% endblock %}
      </section>
    </main>
  </div><!-- /d-flex -->

  {% if reset_sidebar %}
  <script>
    try { localStorage.setItem('itcSidebarCollapsed','0'); } catch(e){}
  </script>
  {% endif %}

  <!-- Modal detalle de curso -->
  <div class="modal fade" id="courseDetailModal" tabindex="-1" aria-labelledby="courseDetailLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="courseDetailLabel">Course detail</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Cerrar"></button>
        </div>
        <div class="modal-body" id="courseDetailBody">
          <div class="text-center text-muted py-3">
            Loading...
          </div>
        </div>
      </div>
    </div>
  </div>

{% block scripts %}
  <!-- JS Bootstrap -->
  <script src="{{ url_for('static', filename='vendor/bootstrap/bootstrap.bundle.min.js') }}"></script>

  <!-- JS FullCalendar -->
  <script src="{{ url_for('static', filename='vendor/fullcalendar/index.global.min.js') }}"></script>
  <script src="{{ url_for('static', filename='vendor/fullcalendar/locales-all.global.min.js') }}"></script>

  <!-- Script: reloj -->
  <script>
    (function(){
      const el = document.getElementById('clock');
      if (!el) return;
      function tick(){
        try {
          const now = new Date();
          el.textContent = now.toLocaleString('es-ES', {
            hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit'
          });
        } catch(e){}
      }
      tick();
      setInterval(tick, 1000);
    })();
  </script>

  <!-- Script: sidebar -->
  <script>
    (function () {
      const BODY = document.body;
      const SIDEBAR = document.getElementById('sidebar');
      const KEY  = "itcSidebarCollapsed";
      const btn  = document.getElementById('btn-toggle-sidebar');

      const collapsed = localStorage.getItem(KEY) === "1";
      if (collapsed) BODY.classList.add('sidebar-collapsed');
      if (SIDEBAR) SIDEBAR.setAttribute('aria-hidden', collapsed ? 'true' : 'false');
      if (btn) btn.setAttribute('aria-expanded', (!collapsed).toString());

      function toggleSidebar() {
        BODY.classList.toggle('sidebar-collapsed');
        const isCollapsed = BODY.classList.contains('sidebar-collapsed');
        localStorage.setItem(KEY, isCollapsed ? "1" : "0");
        if (SIDEBAR) SIDEBAR.setAttribute('aria-hidden', isCollapsed ? 'true' : 'false');
        if (btn) btn.setAttribute('aria-expanded', (!isCollapsed).toString());
      }
      if (btn) btn.addEventListener('click', toggleSidebar);
    })();
  </script>
{% endblock %}

  
</body>
</html>
