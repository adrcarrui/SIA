{% extends "base.html" %}

{% block title %}Movements history{% endblock %}

{% block content %}

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Movements history</h2>
  </div>

  <p class="text-muted">
    Total movements: {{ total }}
  </p>

  <div class="card">
    <div class="card-body p-0">

      {# Filters (sticky) #}
      <form method="get" action="{{ url_for('movements.index') }}">
        {# keep global search & reset page when filtering #}
        <input type="hidden" name="q" value="{{ q or '' }}">
        <input type="hidden" name="page" value="1">
        <input type="hidden" name="per_page" value="{{ per_page }}">

        <div class="sticky-top bg-body border-bottom p-2" style="z-index: 30; top: 56px;">
          <div class="row g-2 align-items-end">
            <div class="col-12 col-lg-4">
              <label class="form-label small mb-1">Date</label>
              <div class="d-flex align-items-center gap-2">
                <input
                  type="date"
                  name="date_from"
                  class="form-control form-control-sm"
                  value="{{ filter_date_from or '' }}"
                  aria-label="From date"
                >
                <span class="text-muted small">→</span>
                <input
                  type="date"
                  name="date_to"
                  class="form-control form-control-sm"
                  value="{{ filter_date_to or '' }}"
                  aria-label="To date"
                >
              </div>
            </div>

            <div class="col-12 col-sm-6 col-lg-2">
              <label class="form-label small mb-1">User</label>
              <input
                type="text"
                name="user"
                class="form-control form-control-sm"
                placeholder="Username / email"
                value="{{ filter_user or '' }}"
              >
            </div>

            <div class="col-12 col-sm-6 col-lg-2">
              <label class="form-label small mb-1">Action</label>
              <select name="action" class="form-select form-select-sm">
                <option value="">All</option>
                <option value="create" {% if filter_action == 'create' %}selected{% endif %}>create</option>
                <option value="update" {% if filter_action == 'update' %}selected{% endif %}>update</option>
                <option value="delete" {% if filter_action == 'delete' %}selected{% endif %}>delete</option>
              </select>
            </div>

            <div class="col-12 col-lg-3">
              <label class="form-label small mb-1">Description</label>
              <input
                type="text"
                name="description"
                class="form-control form-control-sm"
                placeholder="Description"
                value="{{ filter_description or '' }}"
              >
            </div>

            <div class="col-12 col-lg-1 d-flex gap-2">
              <button type="submit" class="btn btn-primary btn-sm w-100">Filter</button>
              <a href="{{ url_for('movements.index') }}" class="btn btn-secondary btn-sm w-100">Clear</a>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-sm table-striped align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th style="width:180px;">Date</th>
                <th style="width:220px;">User</th>
                <th style="width:120px;">Action</th>
                <th style="width:240px;">Entity</th>
                <th style="width:90px;">Success</th>
                <th>Description</th>
                <th class="text-end" style="width:90px;">Detail</th>
              </tr>
            </thead>

            <tbody>
            {% if movements %}
              {% for m in movements %}

              {# ---------- entity label heuristics (no backend joins) ---------- #}
              {% set et = (m.entity_type or '') %}
              {% set desc = (m.description or '') %}

              {# course label from description like: course 'XYZ' #}
              {% set course_label = '' %}
              {% if et == 'course' and desc and "course '" in desc %}
                {% set course_label = desc.split("course '")[1].split("'")[0] %}
              {% endif %}

              {# device label from json best-effort #}
              {% set device_label = '' %}
              {% if et == 'device' %}
                {% set ad = m.after_data or {} %}
                {% set bd = m.before_data or {} %}
                {% set device_label = (ad.get('device_name') or ad.get('name') or ad.get('barcode') or bd.get('device_name') or bd.get('name') or bd.get('barcode') or '') %}
              {% endif %}

              {# final entity label #}
              {% set entity_label = '' %}
              {% if et == 'course' %}
                {% set entity_label = course_label %}
              {% elif et == 'device' %}
                {% set entity_label = device_label %}
              {% endif %}

              <tr>
                <td class="text-nowrap">
                  {% if m.created_at %}
                    {{ m.created_at.strftime("%Y-%m-%d %H:%M:%S") }}
                  {% else %}
                    -
                  {% endif %}
                </td>

                <td>
                  {% if m.user %}
                    {{ m.user.username or m.user.email or ("User #" ~ m.user_id) }}
                  {% else %}
                    {{ ("User #" ~ (m.user_id or '')) }}
                  {% endif %}
                </td>

                <td class="text-nowrap">
                  {% if m.action == "create" %}
                    <span class="badge bg-success">create</span>
                  {% elif m.action == "update" %}
                    <span class="badge bg-warning text-dark">update</span>
                  {% elif m.action == "delete" %}
                    <span class="badge bg-danger">delete</span>
                  {% else %}
                    <span class="badge bg-secondary">{{ m.action }}</span>
                  {% endif %}
                </td>

                <td class="text-nowrap">
                  <span class="badge bg-light text-dark border">
                    {{ et or '-' }}
                  </span>

                  {% if entity_label %}
                    <span class="ms-2">{{ entity_label }}</span>
                    {% if m.entity_id is not none %}
                      <span class="text-muted ms-1">(#{{ m.entity_id }})</span>
                    {% endif %}
                  {% else %}
                    <span class="text-muted ms-2">
                      {% if m.entity_id is not none %}#{{ m.entity_id }}{% else %}-{% endif %}
                    </span>
                  {% endif %}
                </td>

                <td class="text-nowrap">
                  {% if m.success %}
                    <span class="badge bg-success">Yes</span>
                  {% else %}
                    <span class="badge bg-danger">No</span>
                  {% endif %}
                </td>

                <td style="max-width:520px;">
                  {% if m.description %}
                    {{ m.description }}
                  {% else %}
                    <span class="text-muted">No description</span>
                  {% endif %}
                </td>

                <td class="text-end">
                  <button
                    type="button"
                    class="btn btn-outline-secondary btn-sm"
                    data-bs-toggle="modal"
                    data-bs-target="#movementDetailModal"
                    data-id="{{ m.id }}"
                    data-date="{{ m.created_at.strftime('%Y-%m-%d %H:%M:%S') if m.created_at else '' }}"
                    data-user="{{ (m.user.username or m.user.email) if m.user else ('User #' ~ (m.user_id or '')) }}"
                    data-action="{{ m.action or '' }}"
                    data-entity-type="{{ et }}"
                    data-entity-id="{{ m.entity_id if m.entity_id is not none else '' }}"
                    data-entity-label="{{ entity_label }}"
                    data-success="{{ 'Yes' if m.success else 'No' }}"
                    data-user-agent="{{ m.user_agent or '' }}"
                    data-before='{{ (m.before_data or {})|tojson }}'
                    data-after='{{ (m.after_data or {})|tojson }}'
                    data-description="{{ m.description or '' }}"
                  >
                    Detail
                  </button>
                </td>
              </tr>
              {% endfor %}
            {% else %}
              <tr>
                <td colspan="7" class="text-center text-muted py-4">
                  No movements registered.
                </td>
              </tr>
            {% endif %}
            </tbody>
          </table>
        </div>
      </form>
    </div>
  </div>

  <!-- Pagination -->
  <nav class="mt-3" aria-label="Audit history pagination">
    <ul class="pagination">
      <li class="page-item {% if not has_prev %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('movements.index',
                            q=q,
                            page=(page-1 if page > 1 else 1),
                            per_page=per_page,
                            user=filter_user,
                            action=filter_action,
                            description=filter_description,
                            date_from=filter_date_from,
                            date_to=filter_date_to) }}"
           tabindex="-1">
          «
        </a>
      </li>

      <li class="page-item active">
        <span class="page-link">{{ page }}</span>
      </li>

      <li class="page-item {% if not has_next %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('movements.index',
                            q=q,
                            page=(page+1 if has_next else page),
                            per_page=per_page,
                            user=filter_user,
                            action=filter_action,
                            description=filter_description,
                            date_from=filter_date_from,
                            date_to=filter_date_to) }}">
          »
        </a>
      </li>
    </ul>
  </nav>

  {# Export links (mantiene filtros + paginación) #}
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2 class="mb-0"></h2>

    <div class="d-flex align-items-center gap-2">
      <span class="small fw-bold me-1">Download as:</span>

      <div class="btn-group btn-group-sm" role="group">
        <a
          class="btn btn-outline-secondary"
          href="{{ url_for('movements.export_movements',
                           format='csv',
                           q=q,
                           user=filter_user,
                           action=filter_action,
                           entity_type=filter_entity_type,
                           description=filter_description,
                           success=filter_success,
                           date_from=filter_date_from,
                           date_to=filter_date_to,
                           page=page,
                           per_page=per_page) }}"
        >CSV</a>

        <a
          class="btn btn-outline-secondary"
          href="{{ url_for('movements.export_movements',
                           format='xlsx',
                           q=q,
                           user=filter_user,
                           action=filter_action,
                           entity_type=filter_entity_type,
                           description=filter_description,
                           success=filter_success,
                           date_from=filter_date_from,
                           date_to=filter_date_to,
                           page=page,
                           per_page=per_page) }}"
        >Excel</a>

        <a
          class="btn btn-outline-secondary"
          href="{{ url_for('movements.export_movements',
                           format='pdf',
                           q=q,
                           user=filter_user,
                           action=filter_action,
                           entity_type=filter_entity_type,
                           description=filter_description,
                           success=filter_success,
                           date_from=filter_date_from,
                           date_to=filter_date_to,
                           page=page,
                           per_page=per_page) }}"
        >PDF</a>
      </div>
    </div>
  </div>

  <!-- Detail Modal -->
  <div class="modal fade" id="movementDetailModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Movement detail</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>

        <div class="modal-body">
          <div class="row g-2 mb-3">
            <div class="col-md-4">
              <div class="small text-muted">Date</div>
              <div class="fw-semibold" id="md-date">-</div>
            </div>
            <div class="col-md-4">
              <div class="small text-muted">User</div>
              <div class="fw-semibold" id="md-user">-</div>
            </div>
            <div class="col-md-4">
              <div class="small text-muted">Action</div>
              <div class="fw-semibold" id="md-action">-</div>
            </div>

            <div class="col-md-6">
              <div class="small text-muted">Entity</div>
              <div class="fw-semibold" id="md-entity">-</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Success</div>
              <div class="fw-semibold" id="md-success">-</div>
            </div>
            <div class="col-md-3">
              <div class="small text-muted">Movement ID</div>
              <div class="fw-semibold" id="md-id">-</div>
            </div>
          </div>

          <div class="mb-3">
            <div class="small text-muted">Description</div>
            <div id="md-description" style="white-space: pre-line;">-</div>
          </div>

          <div class="mb-3 d-none" id="md-devices-wrap">
            <div class="small text-muted mb-1">Devices</div>
            <ul class="mb-0" id="md-devices"></ul>
          </div>

          <div class="mb-3">
            <div class="small text-muted">User agent</div>
            <div class="font-monospace small" style="white-space: pre-wrap;" id="md-user-agent">-</div>
          </div>

          <div class="row g-3">
            <div class="col-md-6">
              <div class="small text-muted mb-1">Before</div>
              <pre class="bg-body-tertiary border rounded p-2 small mb-0" id="md-before" style="white-space: pre-wrap;">{}</pre>
            </div>
            <div class="col-md-6">
              <div class="small text-muted mb-1">After</div>
              <pre class="bg-body-tertiary border rounded p-2 small mb-0" id="md-after" style="white-space: pre-wrap;">{}</pre>
            </div>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const modal = document.getElementById("movementDetailModal");
      if (!modal) return;

      function pretty(jsonStr) {
        try {
          const obj = JSON.parse(jsonStr || "{}");
          return JSON.stringify(obj, null, 2);
        } catch (e) {
          return (jsonStr || "{}");
        }
      }

      function safeParse(jsonStr) {
        try { return JSON.parse(jsonStr || "{}"); }
        catch (e) { return {}; }
      }

      modal.addEventListener("show.bs.modal", function (ev) {
        const btn = ev.relatedTarget;
        if (!btn) return;

        const id = btn.getAttribute("data-id") || "";
        const date = btn.getAttribute("data-date") || "";
        const user = btn.getAttribute("data-user") || "";
        const action = btn.getAttribute("data-action") || "";
        const entityType = btn.getAttribute("data-entity-type") || "";
        const entityId = btn.getAttribute("data-entity-id") || "";
        const entityLabel = btn.getAttribute("data-entity-label") || "";
        const success = btn.getAttribute("data-success") || "";
        const userAgent = btn.getAttribute("data-user-agent") || "";
        const before = btn.getAttribute("data-before") || "{}";
        const after = btn.getAttribute("data-after") || "{}";
        const desc = btn.getAttribute("data-description") || "";

        modal.querySelector("#md-id").textContent = id || "-";
        modal.querySelector("#md-date").textContent = date || "-";
        modal.querySelector("#md-user").textContent = user || "-";
        modal.querySelector("#md-action").textContent = action || "-";

        const entityParts = [];
        if (entityType) entityParts.push(entityType);
        if (entityLabel) entityParts.push(entityLabel);
        if (entityId) entityParts.push("#" + entityId);
        modal.querySelector("#md-entity").textContent = entityParts.length ? entityParts.join(" ") : "-";

        modal.querySelector("#md-success").textContent = success || "-";
        modal.querySelector("#md-user-agent").textContent = userAgent || "-";
        modal.querySelector("#md-description").textContent = desc || "-";
        modal.querySelector("#md-before").textContent = pretty(before);
        modal.querySelector("#md-after").textContent = pretty(after);

        // Devices list (from after_data.devices)
        const afterObj = safeParse(after);
        const devWrap = modal.querySelector("#md-devices-wrap");
        const devUl = modal.querySelector("#md-devices");
        devUl.innerHTML = "";
        if (afterObj && Array.isArray(afterObj.devices) && afterObj.devices.length) {
          afterObj.devices.forEach((d) => {
            const li = document.createElement("li");
            li.textContent = String(d);
            devUl.appendChild(li);
          });
          devWrap.classList.remove("d-none");
        } else {
          devWrap.classList.add("d-none");
        }
      });
    })();
  </script>

{% endblock %}
