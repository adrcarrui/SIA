{% extends "base.html" %}
{% block title %}Movements history{% endblock %}
{% block content %}

<div class="movements-page">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Movements history</h2>
  </div>

  <p class="text-muted mb-2">
    Total movements: {{ total }}
  </p>

  <form method="get" action="{{ url_for('movements.index') }}" class="movements-panel">
    <input type="hidden" name="q" value="{{ q or '' }}">
    <input type="hidden" name="page" value="1">
    <input type="hidden" name="per_page" value="{{ per_page }}">

    <!-- ================= FIXED HEADER (2 ROWS) ================= -->
    <div class="movements-header-2rows">

      <!-- Row 1: column names -->
      <div class="movements-grid-cols movements-grid-cols-head">
        <div class="movements-th">Date</div>
        <div class="movements-th">User</div>
        <div class="movements-th">Action</div>
        <div class="movements-th">Description</div>
      </div>

      <!-- Row 2: filters -->
      <div class="movements-grid-cols movements-grid-cols-filters">

        <!-- Date -->
        <div>
          <div class="d-flex gap-2">
            <input type="date"
                   name="date_from"
                   class="form-control form-control-sm"
                   value="{{ filter_date_from or '' }}">
            <input type="date"
                   name="date_to"
                   class="form-control form-control-sm"
                   value="{{ filter_date_to or '' }}">
          </div>
        </div>

        <!-- User -->
        <div>
          <input type="text"
                 name="user"
                 class="form-control form-control-sm"
                 placeholder="Username / email"
                 value="{{ filter_user or '' }}">
        </div>

        <!-- Action -->
        <div>
          <select name="action" class="form-select form-select-sm">
            <option value="">All</option>
            {% for a in actions %}
              <option value="{{ a }}" {{ 'selected' if filter_action == a else '' }}>
                {{ a }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Description -->
        <div>
          <input type="text"
                 name="description"
                 class="form-control form-control-sm"
                 placeholder="Description"
                 value="{{ filter_description or '' }}">
        </div>

        <!-- Buttons -->
        <div class="d-flex gap-2 justify-content-end text-end">
          <button type="submit" class="btn btn-primary btn-sm">Filter</button>
          <a href="{{ url_for('movements.index') }}" class="btn btn-secondary btn-sm">Clear</a>
        </div>

      </div>
    </div>

    <!-- ================= TABLE BODY (SCROLL ONLY HERE) ================= -->
    <div class="movements-table-scroll">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0 movements-table-fixed">

          <colgroup>
            <col class="col-date">
            <col class="col-user">
            <col class="col-action">
            <col class="col-entity">
            <col class="col-desc">
          </colgroup>

          <tbody>
            {% for m in movements %}
              {% set et = m.entity_type or '' %}
              {% set label = '' %}
              {% if et == 'course' and m.description and "course '" in m.description %}
                {% set label = m.description.split("course '")[1].split("'")[0] %}
              {% endif %}

              <tr>
                <!-- Date -->
                <td class="text-nowrap text-center">
                  {{ m.created_at.strftime("%Y-%m-%d %H:%M:%S") if m.created_at else '-' }}
                </td>

                <!-- User -->
                <td class="text-center">
                  {{ m.user.username if m.user else ('User #' ~ m.user_id) }}
                </td>

                <!-- Action -->
                <td class="text-center">
                  <span class="badge bg-secondary">{{ m.action }}</span>
                </td>

                <!-- Description -->
                <td class="text-truncate text-center">
                  {{ m.description or '' }}
                </td>

                <!-- Detail -->
                <td class="text-end">
                  <button class="btn btn-outline-secondary btn-sm"
                          data-bs-toggle="modal"
                          data-bs-target="#movementDetailModal"
                          data-id="{{ m.id }}">
                    Detail
                  </button>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="6" class="text-center text-muted py-4">
                  No movements registered.
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>

  </form>

</div>
<!-- ================= PAGINATION ================= -->
<nav aria-label="Pagination" class="mt-3">
  <ul class="pagination mb-2">
    <li class="page-item {% if not has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('movements.index',
           q=q,
           page=(page-1 if page>1 else 1),
           per_page=per_page,
           user=filter_user,
           action=filter_action,
           description=filter_description,
           date_from=filter_date_from,
           date_to=filter_date_to) }}">«</a>
    </li>

    <li class="page-item active">
      <span class="page-link">{{ page }}</span>
    </li>

    <li class="page-item {% if not has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('movements.index',
           q=q,
           page=(page+1 if has_next else page),
           per_page=per_page,
           user=filter_user,
           action=filter_action,
           description=filter_description,
           date_from=filter_date_from,
           date_to=filter_date_to) }}">»</a>
    </li>
  </ul>
</nav>
<!-- ================= EXPORTS ================= -->
<div class="d-flex justify-content-between align-items-center">
  <div></div>

  <div class="d-flex align-items-center gap-2">
    <span class="small text-muted fw-bold me-1">Download as:</span>

    <div class="btn-group btn-group-sm">
      <a class="btn btn-outline-secondary"
         href="{{ url_for('movements.export_movements',
           format='csv',
           q=q,
           user=filter_user,
           action=filter_action,
           description=filter_description,
           date_from=filter_date_from,
           date_to=filter_date_to,
           page=page,
           per_page=per_page) }}">CSV</a>

      <a class="btn btn-outline-secondary"
         href="{{ url_for('movements.export_movements',
           format='xlsx',
           q=q,
           user=filter_user,
           action=filter_action,
           description=filter_description,
           date_from=filter_date_from,
           date_to=filter_date_to,
           page=page,
           per_page=per_page) }}">Excel</a>

      <a class="btn btn-outline-secondary"
         href="{{ url_for('movements.export_movements',
           format='pdf',
           q=q,
           user=filter_user,
           action=filter_action,
           description=filter_description,
           date_from=filter_date_from,
           date_to=filter_date_to,
           page=page,
           per_page=per_page) }}">PDF</a>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.body.classList.add("no-page-scroll");
});
</script>

{% endblock %}
