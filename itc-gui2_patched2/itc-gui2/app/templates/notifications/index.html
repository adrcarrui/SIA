{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h2 class="mb-0">Notifications</h2>

  <div class="d-flex align-items-center gap-2 flex-wrap">
    <span class="me-2">
      Unread:
      <span class="badge bg-danger">{{ unread_count }}</span>
    </span>

    <form method="post"
          action="{{ url_for('notifications.mark_all_read',
                             status=filter_status,
                             unread=filter_unread,
                             severity=filter_severity) }}"
          class="m-0">
      <button class="btn btn-outline-success btn-sm" type="submit">
        Mark all read
      </button>
    </form>

    <form method="post"
          action="{{ url_for('notifications.mark_all_done',
                             status=filter_status,
                             unread=filter_unread,
                             severity=filter_severity) }}"
          class="m-0">
      <button class="btn btn-outline-success btn-sm" type="submit">
        Mark all done
      </button>
    </form>
  </div>
</div>

<form method="get" class="row g-2 align-items-end mb-3">
  <div class="col-md-3">
    <label class="form-label">Severity</label>
    <select name="severity" class="form-select form-select-sm">
      <option value="" {% if not filter_severity %}selected{% endif %}>All</option>
      <option value="notice" {% if filter_severity == 'notice' %}selected{% endif %}>notice</option>
      <option value="warning" {% if filter_severity == 'warning' %}selected{% endif %}>warning</option>
      <option value="critical" {% if filter_severity == 'critical' %}selected{% endif %}>critical</option>
    </select>
  </div>

    <div class="col-md-3">
    <label class="form-label">Status</label>
    <select name="status" class="form-select form-select-sm">
      <option value="" {% if not filter_status %}selected{% endif %}>All</option>
      <option value="open" {% if filter_status == 'open' %}selected{% endif %}>open</option>
      <option value="in_progress" {% if filter_status == 'in_progress' %}selected{% endif %}>in_progress</option>
      <option value="done" {% if filter_status == 'done' %}selected{% endif %}>done</option>
      <option value="dismissed" {% if filter_status == 'dismissed' %}selected{% endif %}>dismissed</option>
    </select>
  </div>

  <div class="col-md-3">
    <label class="form-label">Unread</label>
    <select name="unread" class="form-select form-select-sm">
      <option value="" {% if not filter_unread %}selected{% endif %}>All</option>
      <option value="1" {% if filter_unread == '1' %}selected{% endif %}>Only unread</option>
    </select>
  </div>

  <div class="col-md-3 d-flex gap-2">
    <button class="btn btn-primary btn-sm mt-4" type="submit">Filter</button>
    <a class="btn btn-secondary btn-sm mt-4"
       href="{{ url_for('notifications.index',
                        status='',
                        unread='',
                        severity='') }}">
      Clear
    </a>
  </div>
</form>

<div class="table-responsive">
  <table class="table table-sm align-middle">
    <thead class="table-light">
      <tr>
        <th style="width:170px;">When</th>
        <th style="width:90px;">Severity</th>
        <th>Description</th>
        <th style="width:130px;">Status</th>
        <th style="width:190px;">Actions</th>
      </tr>
    </thead>

    <tbody>
      {% for n in notifications %}
      <tr class="{% if not n.read_at %}table-warning{% endif %}">
        <td class="text-muted small">
          {{ n.created_at.strftime('%d/%m/%Y %H:%M') }}
        </td>

        <td>
          {% set sev = (n.severity or 'notice')|lower|trim %}
          {% set notif_label = {'notice':'Normal','warning':'Important','critical':'Urgent'}.get(sev, sev) %}
          {% set scolor = {'notice':'secondary','warning':'warning','critical':'danger'}.get(sev, 'secondary') %}
          <span class="badge bg-{{ scolor }}">{{ notif_label }}</span>
        </td>

        <td style="max-width:260px;">
          <div class="fw-semibold">{{ n.title }}</div>
          {% if n.message %}
            <div class="text-muted small" style="white-space: pre-line;">
              {{ n.message }}
            </div>
          {% endif %}
        </td>

        <td>
          {% set st = (n.status or 'open')|lower %}
          {% set tcolor = {'open':'secondary','in_progress':'primary','done':'success','dismissed':'dark'}.get(st, 'secondary') %}
          <span class="badge bg-{{ tcolor }}">{{ st }}</span>
        </td>

        <td class="text-end text-nowrap">
          <div class="d-flex justify-content-end align-items-center gap-2 flex-nowrap">

            {% if not n.read_at %}
            <form method="post"
                  action="{{ url_for('notifications.mark_read', notif_id=n.id, **request.args) }}"
                  class="m-0">
              <button class="btn btn-outline-success btn-sm" type="submit">
                Mark read
              </button>
            </form>
            {% endif %}

            <form method="post"
                  action="{{ url_for('notifications.change_status', notif_id=n.id, **request.args) }}"
                  class="m-0 d-flex align-items-center gap-1">
              <select name="status"
                      class="form-select form-select-sm"
                      style="width:120px; min-width:120px;">
                <option value="open" {% if st == 'open' %}selected{% endif %}>open</option>
                <option value="in_progress" {% if st == 'in_progress' %}selected{% endif %}>in_progress</option>
                <option value="done" {% if st == 'done' %}selected{% endif %}>done</option>
                <option value="dismissed" {% if st == 'dismissed' %}selected{% endif %}>dismissed</option>
              </select>
              <button class="btn btn-primary btn-sm" type="submit">
                Save
              </button>
            </form>

          </div>
        </td>
      </tr>
      {% else %}
      <tr>
        <td colspan="5" class="text-center text-muted py-4">
          No notifications.
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<nav aria-label="Pagination">
  <ul class="pagination">
    <li class="page-item {% if not has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('notifications.index',
                          page=(page-1 if page>1 else 1),
                          per_page=per_page,
                          status=filter_status,
                          unread=filter_unread,
                          severity=filter_severity) }}">«</a>
    </li>

    <li class="page-item active">
      <span class="page-link">{{ page }}</span>
    </li>

    <li class="page-item {% if not has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('notifications.index',
                          page=(page+1 if has_next else page),
                          per_page=per_page,
                          status=filter_status,
                          unread=filter_unread,
                          severity=filter_severity) }}">»</a>
    </li>
  </ul>
</nav>

{% endblock %}
