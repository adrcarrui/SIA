{% extends "base.html" %}
{% block content %}

<div class="users-page">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Users</h2>
    <a href="{{ url_for('users.new_user') }}" class="btn btn-primary btn-sm">New user</a>
  </div>

  <p class="text-muted mb-2">
    Total users: {{ "{:,}".format(total or 0) }}
  </p>

  <form method="get" action="{{ url_for('users.index') }}" class="users-panel">
    <input type="hidden" name="q" value="{{ q or '' }}">
    <input type="hidden" name="page" value="1">
    <input type="hidden" name="per_page" value="{{ per_page }}">

    <!-- ================= FIXED HEADER (2 ROWS) ================= -->
    <div class="users-header-2rows" id="usersHeader">

      <!-- Row 1: column names -->
      <div class="users-grid-cols users-grid-cols-head">
        <div class="users-th text-center fw-bold">#</div>
        <div class="users-th text-center fw-bold">Name</div>
        <div class="users-th text-center fw-bold">Surname</div>
        <div class="users-th text-center fw-bold">Username</div>
        <div class="users-th text-center fw-bold">Email</div>
        <div class="users-th text-center fw-bold">Role</div>
        <div class="users-th text-center fw-bold">Actions</div>
      </div>

      <!-- Row 2: filters -->
      <div class="users-grid-cols users-grid-cols-filters">

        <!-- # (no filter) -->
        <div></div>

        <!-- Name -->
        <div>
          <input type="text"
                 class="form-control form-control-sm"
                 name="name"
                 placeholder="Name"
                 value="{{ filter_name or '' }}">
        </div>

        <!-- Surname -->
        <div>
          <input type="text"
                 class="form-control form-control-sm"
                 name="surname"
                 placeholder="Surname"
                 value="{{ filter_surname or '' }}">
        </div>

        <!-- Username -->
        <div>
          <input type="text"
                 class="form-control form-control-sm"
                 name="username"
                 placeholder="Username"
                 value="{{ filter_username or '' }}">
        </div>

        <!-- Email -->
        <div>
          <input type="text"
                 class="form-control form-control-sm"
                 name="email"
                 placeholder="Email"
                 value="{{ filter_email or '' }}">
        </div>

        <!-- Role -->
        <div>
          <input type="text"
                 class="form-control form-control-sm"
                 name="role"
                 placeholder="Role"
                 value="{{ filter_role or '' }}">
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2 justify-content-center">
          <button type="submit" class="btn btn-primary btn-sm">Filter</button>
          <a href="{{ url_for('users.index') }}" class="btn btn-secondary btn-sm">Clear</a>
        </div>

      </div>
    </div>

    <!-- ================= TABLE BODY (SCROLL ONLY HERE) ================= -->
    <div class="users-table-scroll" id="usersScroll">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0 users-table-fixed">

          <!-- Force SAME column widths as header grid -->
          <colgroup>
            <col style="width: var(--usr-col-num);">
            <col style="width: var(--usr-col-name);">
            <col style="width: var(--usr-col-surname);">
            <col style="width: var(--usr-col-username);">
            <col style="width: var(--usr-col-email);">
            <col style="width: var(--usr-col-role);">
            <col style="width: var(--usr-col-actions);">
          </colgroup>

          <tbody>
            {% for u in users %}
            <tr>
              <td class="text-center">{{ loop.index + ((page - 1) * per_page) }}</td>
              <td class="text-center">{{ u.name }}</td>
              <td class="text-center">{{ u.surname or '—' }}</td>
              <td class="text-center">{{ u.username or '—' }}</td>
              <td class="text-center">{{ u.email or '—' }}</td>
              <td class="text-center">{{ u.role }}</td>
              <td>
                <div class="d-flex justify-content-center gap-2">

                  {% if can_edit_user(current_user, u) %}
                    <a class="btn btn-secondary btn-sm"
                       href="{{ url_for('users.edit_user', user_id=u.id) }}">
                      Edit
                    </a>
                  {% endif %}

                  {% if can_delete_user(current_user, u) %}
                    <form method="post"
                          action="{{ url_for('users.delete_user', user_id=u.id) }}"
                          class="d-inline delete-user-form">
                      {% if csrf_token is defined %}
                        {{ csrf_token() }}
                      {% endif %}
                      <button type="button"
                              class="btn btn-sm btn-danger btn-user-delete"
                              data-username="{{ u.username or u.email or ('User #' ~ u.id) }}"
                              data-url="{{ url_for('users.delete_user', user_id=u.id) }}">
                        Delete
                      </button>
                    </form>
                  {% endif %}

                </div>
              </td>
            </tr>
            {% endfor %}

            {% if not users %}
            <tr>
              <td colspan="7" class="text-center text-body-secondary py-4">
                No results
              </td>
            </tr>
            {% endif %}
          </tbody>

        </table>
      </div>
    </div>

  </form>

  <!-- ================= PAGINATION ================= -->
  <nav aria-label="Pagination" class="mt-3">
    <ul class="pagination mb-2">
      <li class="page-item {% if not has_prev %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('users.index',
             q=q,
             page=(page-1 if page>1 else 1),
             per_page=per_page,
             name=filter_name,
             surname=filter_surname,
             username=filter_username,
             email=filter_email,
             role=filter_role) }}">«</a>
      </li>
      <li class="page-item active">
        <span class="page-link">{{ page }}</span>
      </li>
      <li class="page-item {% if not has_next %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('users.index',
             q=q,
             page=(page+1 if has_next else page),
             per_page=per_page,
             name=filter_name,
             surname=filter_surname,
             username=filter_username,
             email=filter_email,
             role=filter_role) }}">»</a>
      </li>
    </ul>
  </nav>

  <!-- ================= EXPORTS ================= -->
  <div class="d-flex justify-content-between align-items-center">
    <div></div>
    <div class="d-flex align-items-center gap-2">
      <span class="small text-muted fw-bold me-1">Download as:</span>
      <div class="btn-group btn-group-sm" role="group">

        <a class="btn btn-outline-secondary"
           href="{{ url_for('users.export_users',
             format='csv',
             q=q,
             page=page,
             per_page=per_page,
             name=filter_name,
             surname=filter_surname,
             username=filter_username,
             uid=filter_uid,
             email=filter_email,
             role=filter_role) }}">CSV</a>

        <a class="btn btn-outline-secondary"
           href="{{ url_for('users.export_users',
             format='xlsx',
             q=q,
             page=page,
             per_page=per_page,
             name=filter_name,
             surname=filter_surname,
             username=filter_username,
             uid=filter_uid,
             email=filter_email,
             role=filter_role) }}">Excel</a>

        <a class="btn btn-outline-secondary"
           href="{{ url_for('users.export_users',
             format='pdf',
             q=q,
             page=page,
             per_page=per_page,
             name=filter_name,
             surname=filter_surname,
             username=filter_username,
             uid=filter_uid,
             email=filter_email,
             role=filter_role) }}">PDF</a>

      </div>
    </div>
  </div>

</div>

{% endblock %}
