{% extends "base.html" %}

{% block content %}
<div class="container py-3">
  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Alerts</h2>

    <div class="d-flex align-items-center gap-2">
      <span class="small fw-bold me-1">View:</span>

      <a
        href="{{ url_for('alerts.alerts_index') }}"
        class="btn btn-sm btn-outline-secondary {% if not filter_my %}active{% endif %}">
        All
      </a>

      <a
        href="{{ url_for('alerts.alerts_index', my=1) }}"
        class="btn btn-sm btn-outline-primary {% if filter_my == '1' %}active{% endif %}">
        My Alerts
      </a>
    </div>
  </div>

  <form method="get">
    <table class="table table-sm table-striped align-middle">
      <thead>
        <tr>
          <th style="width:110px;">Severity</th>
          <th style="width:180px;">Type</th>
          <th>Description</th>
          <th style="width:220px;">Course</th>
          <th style="width:180px;">Responsible</th>
          <th style="width:210px;">Actions</th>
        </tr>

        <tr>
          <!-- Severity -->
          <th>
            <select name="severity" class="form-select form-select-sm">
              <option value="">All</option>
              <option value="notice"   {% if severity == 'notice' %}selected{% endif %}>Notice</option>
              <option value="warning"  {% if severity == 'warning' %}selected{% endif %}>Warning</option>
              <option value="critical" {% if severity == 'critical' %}selected{% endif %}>Critical</option>
            </select>
          </th>

          <!-- State -->
          <th>
            <select name="state" class="form-select form-select-sm mt-1">
              <option value="" {% if not state %}selected{% endif %}>Any state</option>
              <option value="open" {% if state == 'open' %}selected{% endif %}>Open</option>
              <option value="acked" {% if state == 'acked' %}selected{% endif %}>Acked</option>
              <option value="snoozed" {% if state == 'snoozed' %}selected{% endif %}>Snoozed</option>
              <option value="ignored" {% if state == 'ignored' %}selected{% endif %}>Ignored</option>
            </select>
          </th>

          <!-- Search text -->
          <th>
            <input
              type="text"
              class="form-control form-control-sm"
              name="q"
              placeholder="Search text"
              value="{{ q or '' }}"
            >
          </th>

          <!-- Course search -->
          <th>
            <input
              type="text"
              class="form-control form-control-sm"
              name="course_q"
              placeholder="Search course name / code"
              value="{{ course_q or '' }}"
            >
          </th>

          <!-- Responsible -->
          <th>
            <input
              type="text"
              class="form-control form-control-sm"
              name="responsible"
              placeholder="Responsible"
              value="{{ responsible or '' }}"
            >
          </th>

          <!-- Buttons -->
          <th class="text-nowrap">
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
            <a href="{{ url_for('alerts.alerts_index') }}" class="btn btn-secondary btn-sm">Clear</a>

            <div class="form-check form-check-inline ms-2">
              <input class="form-check-input" type="checkbox" id="showHiddenChk" name="show_hidden" value="1"
                     {% if show_hidden == '1' %}checked{% endif %}>
              <label class="form-check-label small" for="showHiddenChk">Show hidden</label>
            </div>

            {% if filter_my == '1' %}
              <input type="hidden" name="my" value="1">
            {% endif %}
          </th>
        </tr>
      </thead>

      <tbody>
        {% for alert in alerts %}
        {% set course_obj = alert.get('course') %}
        {% set course_id = alert.get('course_id') or (course_obj.id if course_obj else None) %}
        {% set scope = alert.get('scope') or '' %}
        {% set reasons = alert.get('reasons') or [] %}

        <tr>
          <!-- Severity -->
          <td>
            {% if alert.get('severity') == 'notice' %}
              <span class="badge bg-info text-dark">Notice</span>
            {% elif alert.get('severity') == 'warning' %}
              <span class="badge bg-warning text-dark">Warning</span>
            {% elif alert.get('severity') == 'critical' %}
              <span class="badge bg-danger">Critical</span>
            {% else %}
              -
            {% endif %}
          </td>

          <!-- Type: state + note -->
          <td>
            {% if reasons %}
              <ul class="mb-0 ps-3">
                {% for r in reasons %}
                  {% set st = (r.get('state') or 'open')|lower %}
                  <li class="d-flex align-items-start justify-content-between gap-2"
                      data-reason
                      data-scope="{{ scope }}"
                      data-course-id="{{ course_id }}"
                      data-alert-key="{{ r.get('key') }}"
                  >
                    <div class="flex-grow-1">
                      {% if st == 'acked' %}
                        <span class="badge bg-secondary">Acked</span>
                      {% elif st == 'snoozed' %}
                        <span class="badge bg-dark">Snoozed</span>
                      {% elif st == 'ignored' %}
                        <span class="badge bg-light text-dark">Ignored</span>
                      {% else %}
                        <span class="badge bg-primary">Open</span>
                      {% endif %}

                      {% if r.get('note') %}
                        <div class="text-muted small mt-1">{{ r.get('note') }}</div>
                      {% endif %}

                      {% if r.get('snooze_until') %}
                      <div class="text-muted small mt-1 snooze-until"
                          data-utc="{{ r.get('snooze_until') }}">
                        <div>Snooze until</div>
                        <div class="local-datetime">—</div>
                      </div>
                      {% endif %}
                    </div>
                  </li>
                {% endfor %}
              </ul>
            {% else %}
              <span class="text-muted">-</span>
            {% endif %}
          </td>

          <!-- Description -->
          <td>
            {% if reasons %}
              <ul class="mb-0 ps-3">
                {% for r in reasons %}
                  <li class="small">{{ r.get('text') }}</li>
                {% endfor %}
              </ul>
            {% else %}
              <div style="white-space: pre-line;">{{ alert.get('message') }}</div>
            {% endif %}
          </td>

          <!-- Course -->
          <td>
            {% if course_obj %}
              {{ course_obj.name or course_obj.course or ('Course #' ~ course_obj.id) }}
            {% else %}
              -
            {% endif %}
          </td>

          <!-- Responsible -->
          <td>
            {% set resp = alert.get('responsible') or (course_obj.responsible if course_obj and course_obj.responsible else None) %}
            {% if resp %}
              {{ resp.username or (resp.name ~ ' ' ~ (resp.surname or '')) }}
            {% else %}
              -
            {% endif %}
          </td>

          <!-- Actions: botones por reason -->
          <td>
            {% if course_obj and reasons %}
              {% for r in reasons %}
                {% set key = r.get('key') %}
                <div class="btn-group btn-group-sm mb-1" role="group">
                  <button
                    type="button"
                    class="btn btn-sm btn-outline-secondary"
                    data-bs-toggle="modal"
                    data-bs-target="#courseModal"
                    data-url="{{ url_for('courses.detail_fragment', course_id=course_obj.id) }}">
                    View
                  </button>

                  <button type="button"
                          class="btn btn-outline-secondary"
                          data-action="ack"
                          data-scope="{{ scope }}"
                          data-course-id="{{ course_id }}"
                          data-alert-key="{{ key }}">
                    Ack
                  </button>

                  <button type="button"
                          class="btn btn-outline-dark dropdown-toggle"
                          data-bs-toggle="dropdown"
                          aria-expanded="false">
                    Snooze
                  </button>

                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item"
                           href="#"
                           data-action="snooze"
                           data-minutes="60"
                           data-scope="{{ scope }}"
                           data-course-id="{{ course_id }}"
                           data-alert-key="{{ key }}">1 hour</a></li>

                    <li><a class="dropdown-item"
                           href="#"
                           data-action="snooze"
                           data-minutes="240"
                           data-scope="{{ scope }}"
                           data-course-id="{{ course_id }}"
                           data-alert-key="{{ key }}">4 hours</a></li>

                    <li><a class="dropdown-item"
                           href="#"
                           data-action="snooze"
                           data-minutes="1440"
                           data-scope="{{ scope }}"
                           data-course-id="{{ course_id }}"
                           data-alert-key="{{ key }}">1 day</a></li>

                    <li><a class="dropdown-item"
                           href="#"
                           data-action="snooze"
                           data-minutes="10080"
                           data-scope="{{ scope }}"
                           data-course-id="{{ course_id }}"
                           data-alert-key="{{ key }}">7 days</a></li>
                  </ul>

                  <button type="button"
                          class="btn btn-outline-danger"
                          data-action="ignore"
                          data-scope="{{ scope }}"
                          data-course-id="{{ course_id }}"
                          data-alert-key="{{ key }}">
                    Ignore
                  </button>

                  <button type="button"
                          class="btn btn-outline-primary"
                          data-action="open"
                          data-scope="{{ scope }}"
                          data-course-id="{{ course_id }}"
                          data-alert-key="{{ key }}">
                    Open
                  </button>
                </div>
              {% endfor %}
            {% elif course_obj %}
              <button
                type="button"
                class="btn btn-sm btn-outline-secondary"
                data-bs-toggle="modal"
                data-bs-target="#courseModal"
                data-url="{{ url_for('courses.detail_fragment', course_id=course_obj.id) }}">
                View
              </button>
            {% endif %}
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="6" class="text-center text-muted small">
            No alerts found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>

{# Pagination #}
<nav aria-label="Pagination">
  <ul class="pagination">
    <li class="page-item {% if not has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('alerts.alerts_index',
                          page=(page-1 if page>1 else 1),
                          per_page=per_page,
                          my=filter_my,
                          severity=severity,
                          q=q,
                          responsible=responsible,
                          state=state,
                          show_hidden=show_hidden,
                          course_q=course_q) }}">«</a>
    </li>

    <li class="page-item active">
      <span class="page-link">{{ page }}</span>
    </li>

    <li class="page-item {% if not has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('alerts.alerts_index',
                          page=(page+1 if has_next else page),
                          per_page=per_page,
                          my=filter_my,
                          severity=severity,
                          q=q,
                          responsible=responsible,
                          state=state,
                          show_hidden=show_hidden,
                          course_q=course_q) }}">»</a>
    </li>
  </ul>
</nav>

<!-- Modal -->
<div class="modal fade" id="courseModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Course details</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="courseModalBody">
        <div class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
  {{ super() }}
  <script>
    // Course modal
    function loadCourseDetail(url) {
      const modalEl = document.getElementById('courseModal');
      const modalBody = document.getElementById('courseModalBody');

      modalBody.innerHTML = `
        <div class="text-center py-5">
          <div class="spinner-border" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
        </div>
      `;

      fetch(url)
        .then(resp => {
          if (!resp.ok) throw new Error("HTTP " + resp.status);
          return resp.text();
        })
        .then(html => {
          modalBody.innerHTML = html;
          bootstrap.Modal.getOrCreateInstance(modalEl).show();
        })
        .catch(err => {
          console.error(err);
          modalBody.innerHTML = `<div class="alert alert-danger">Error loading course details.</div>`;
          bootstrap.Modal.getOrCreateInstance(modalEl).show();
        });
    }

    document.addEventListener('click', function (e) {
      const btn = e.target.closest('[data-bs-target="#courseModal"][data-url]');
      if (!btn) return;
      e.preventDefault();
      loadCourseDetail(btn.dataset.url);
    });

    async function postJSON(url, payload) {
      const resp = await fetch(url, {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify(payload)
      });
      const data = await resp.json().catch(() => ({}));
      if (!resp.ok || data.ok === false) {
        throw new Error(data.error || ("HTTP " + resp.status));
      }
      return data;
    }

    // ISO8601 compatible with Python datetime.fromisoformat (avoid trailing 'Z')
    function toIsoNoZ(dt) {
      const iso = dt.toISOString(); // ends with Z
      return iso.replace("Z", "+00:00");
    }

    document.addEventListener("click", async function(e) {
      const actionEl = e.target.closest("[data-action]");
      if (!actionEl) return;

      if (actionEl.tagName === "A") e.preventDefault();

      const action = actionEl.dataset.action;
      const scope = actionEl.dataset.scope;
      const courseId = actionEl.dataset.courseId;
      const alertKey = actionEl.dataset.alertKey;

      if (!scope || !courseId || !alertKey) {
        console.error("Missing data-scope/data-course-id/data-alert-key on action element", actionEl);
        return;
      }

      try {
        if (action === "ack") {
          const note = window.prompt("Add a note (optional):", "") || "";
          await postJSON("/alerts/api/alerts/ack", {
            scope,
            course_id: parseInt(courseId, 10),
            alert_key: alertKey,
            note
          });
          window.location.reload();
          return;
        }

        if (action === "ignore") {
          await postJSON("/alerts/api/alerts/ignore", {
            scope,
            course_id: parseInt(courseId, 10),
            alert_key: alertKey
          });
          window.location.reload();
          return;
        }

        if (action === "open") {
          await postJSON("/alerts/api/alerts/open", {
            scope,
            course_id: parseInt(courseId, 10),
            alert_key: alertKey
          });
          window.location.reload();
          return;
        }

        if (action === "snooze") {
          const minutes = parseInt(actionEl.dataset.minutes || "0", 10);
          if (!minutes) return;

          const until = new Date(Date.now() + minutes * 60 * 1000);
          const untilISO = toIsoNoZ(until);

          await postJSON("/alerts/api/alerts/snooze", {
            scope,
            course_id: parseInt(courseId, 10),
            alert_key: alertKey,
            until: untilISO
          });
          window.location.reload();
          return;
        }
      } catch (err) {
        console.error(err);
        alert("Action failed: " + err.message);
      }
    });

document.querySelectorAll(".snooze-until").forEach(el => {
    const utcStr = el.dataset.utc;
    if (!utcStr) return;

    const d = new Date(utcStr);
    if (isNaN(d)) return;

    // Formato español, hora local del navegador
    const formatted = d.toLocaleString("es-ES", {
      dateStyle: "short",
      timeStyle: "short"
    });

    const span = el.querySelector(".local-datetime");
    if (span) span.textContent = formatted;
  });

  </script>
{% endblock %}