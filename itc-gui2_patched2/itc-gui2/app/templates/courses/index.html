{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <h2 class="mb-0">Courses</h2>
  <div class="d-flex align-items-center gap-2">
    <!--<form class="d-flex" method="get" action="{{ url_for('courses.index') }}">
      <input name="q"
             value="{{ q or '' }}"
             class="form-control form-control-sm me-2"
             placeholder="Search course...">
      <button class="btn btn-sm btn-outline-primary ms-2">ğŸ”</button>
    </form>-->
    <a
      href="{{ url_for('courses.index') }}"
      class="btn btn-sm btn-outline-secondary {% if not filter_my %}active{% endif %}">
      All
    </a>

    <a
      href="{{ url_for('courses.index',
                       q=q,
                       course=filter_course,
                       name=filter_name,
                       client=filter_client,
                       status=filter_status,
                       notes=filter_notes,
                       start_date=filter_start_date,
                       end_date=filter_end_date,
                       my=1) }}"
      class="btn btn-primary btn-sm {% if filter_my == '1' %}active{% endif %}">
      My Courses
    </a>

    <a class="btn btn-sm btn-primary" href="{{ url_for('courses.new_course') }}">New course</a>
  </div>
</div>

<div class="table-responsive">
  <form method="get" action="{{ url_for('courses.index') }}">
    {# mantener bÃºsqueda global y resetear pÃ¡gina al filtrar #}
    <input type="hidden" name="q" value="{{ q or '' }}">
    <input type="hidden" name="page" value="1">
    <input type="hidden" name="per_page" value="{{ per_page }}">

    <table class="table table-sm align-middle">
      <thead class="table-light">
        <tr>
          <th style="width:70px;">#</th>
          <th>Course</th>
          <th>Name</th>
          <th>Client</th>
          <th>Start</th>
          <th>End</th>
          <th>Status</th>
          <th>Notes</th>
          <th style="width:150px;">Actions</th>
        </tr>

        {# fila de filtros por columna #}
        <tr>
          <th></th>

          <th>
            <input
              type="text"
              class="form-control form-control-sm"
              name="course"
              placeholder="Course"
              value="{{ filter_course or '' }}"
            >
          </th>

          <th>
            <input
              type="text"
              class="form-control form-control-sm"
              name="name"
              placeholder="Name"
              value="{{ filter_name or '' }}"
            >
          </th>

          <th>
            <input
              type="text"
              class="form-control form-control-sm"
              name="client"
              placeholder="Client"
              value="{{ filter_client or '' }}"
            >
          </th>

          <th>
            <input
              type="date"
              class="form-control form-control-sm"
              name="start_date"
              value="{{ filter_start_date or '' }}"
            >
          </th>

          <th>
            <input
              type="date"
              class="form-control form-control-sm"
              name="end_date"
              value="{{ filter_end_date or '' }}"
            >
          </th>

          <th>
            <select
              name="status"
              class="form-select form-select-sm"
            >
              <option value="">All</option>
              <option value="planned"   {% if filter_status == 'planned' %}selected{% endif %}>planned</option>
              <option value="active"    {% if filter_status == 'active' %}selected{% endif %}>active</option>
              <option value="finished"  {% if filter_status == 'finished' %}selected{% endif %}>finished</option>
              <option value="cancelled" {% if filter_status == 'cancelled' %}selected{% endif %}>cancelled</option>
            </select>
          </th>

          <th>
            <input
              type="text"
              class="form-control form-control-sm"
              name="notes"
              placeholder="Notes"
              value="{{ filter_notes or '' }}"
            >
          </th>

          <th class="text-end">
            <button type="submit" class="btn btn-primary btn-sm">Filter</button>
            <a href="{{ url_for('courses.index') }}" class="btn btn-secondary btn-sm">Clear</a>
          </th>
        </tr>
      </thead>

      <tbody>
        {% for c in courses %}
        <tr>
          <td class="text-muted">{{ ((page - 1) * per_page) + loop.index }}</td>
          <td>{{ c.course or 'â€”'}}</td>
          <td>{{ c.name or 'â€”' }}</td>
          <td>{{ c.client or 'â€”' }}</td>
          <td class="text-nowrap">
            {{ c.start_date if c.start_date is not none else 'â€”' }}
          </td>
          <td class="text-nowrap">
            {{ c.end_date if c.end_date is not none else 'â€”' }}
          </td>
          <td>
            {% set status_color = {
              'active':'success',
              'finished':'secondary',
              'lost':'warning',
              'cancelled':'danger',
              'planned':"dark"
            }.get((c.auto_status or '')|lower, 'light') %}
            <span class="badge text-bg-{{ status_color }}">{{ c.auto_status or 'â€”' }}</span>
          </td>
          <td class="text-truncate" style="max-width:260px;">
            {{ c.notes if c is defined and c.notes is not none else '' }}
          </td>
          <td class="text-end">
            <div class="d-flex align-items-center gap-2">
              <a href="{{ url_for('assignments.new_bulk', course_id=c.id) }}"
                 class="btn btn-sm btn-primary">
                Associate
              </a>
              <a href="{{ url_for('courses.edit_course', course_id=c.id) }}"
                 class="btn btn-secondary btn-sm">
                Edit
              </a>
              <form action="{{ url_for('courses.delete_course', course_id=c.id) }}"
                    method="post"
                    onsubmit="return confirm('Delete course #{{ c.id }}?');">
                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
              </form>
            </div>
          </td>
        </tr>
        {% else %}
        <tr>
          <td colspan="9" class="text-center text-muted py-4">
            {% if q %}
              No courses found for â€œ{{ q }}â€.
            {% else %}
              No courses registered.
            {% endif %}
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </form>
</div>

<nav aria-label="Pagination">
  <ul class="pagination">
    <li class="page-item {% if not has_prev %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('courses.index',
                          q=q,
                          page=(page-1 if page>1 else 1),
                          per_page=per_page,
                          course=filter_course,
                          name=filter_name,
                          client=filter_client,
                          status=filter_status,
                          start_date=filter_start_date,
                          end_date=filter_end_date,
                          notes=filter_notes) }}">Â«</a>
    </li>
    <li class="page-item active"><span class="page-link">{{ page }}</span></li>
    <li class="page-item {% if not has_next %}disabled{% endif %}">
      <a class="page-link"
         href="{{ url_for('courses.index',
                          q=q,
                          page=(page+1 if has_next else page),
                          per_page=per_page,
                          course=filter_course,
                          name=filter_name,
                          client=filter_client,
                          status=filter_status,
                          start_date=filter_start_date,
                          end_date=filter_end_date,
                          notes=filter_notes) }}">Â»</a>
    </li>
  </ul>
</nav>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="mb-0"></h2>

  <div class="d-flex align-items-center gap-2">
    <span class="small fw-bold me-1">Download as:</span>

    <div class="btn-group btn-group-sm" role="group">
      <a
        class="btn btn-outline-secondary"
        href="{{ url_for('courses.export_courses',
                         format='csv',
                         q=q,
                         course=filter_course,
                         name=filter_name,
                         client=filter_client,
                         status=filter_status,
                         notes=filter_notes,
                         start_date=filter_start_date,
                         end_date=filter_end_date,
                         page=page,
                         per_page=per_page) }}"
      >CSV</a>

      <a
        class="btn btn-outline-secondary"
        href="{{ url_for('courses.export_courses',
                         format='xlsx',
                         q=q,
                         course=filter_course,
                         name=filter_name,
                         client=filter_client,
                         status=filter_status,
                         notes=filter_notes,
                         start_date=filter_start_date,
                         end_date=filter_end_date,
                         page=page,
                         per_page=per_page) }}"
      >Excel</a>

      <a
        class="btn btn-outline-secondary"
        href="{{ url_for('courses.export_courses',
                         format='pdf',
                         q=q,
                         course=filter_course,
                         name=filter_name,
                         client=filter_client,
                         status=filter_status,
                         notes=filter_notes,
                         start_date=filter_start_date,
                         end_date=filter_end_date,
                         page=page,
                         per_page=per_page) }}"
      >PDF</a>
    </div>
  </div>
</div>

{% endblock %}
