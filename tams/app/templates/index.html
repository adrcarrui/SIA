{% extends "base.html" %}

{% block content %}
<h2 class="mb-3 d-flex justify-content-between align-items-center">
  <span>Dashboard</span>
</h2>

<div id="itc-pickup-container">
  {% include "dashboard/_itc_pickup_fragment.html" %}
</div>

<div class="row mb-4 g-3 row-cols-1 row-cols-md-2"></div>

<div class="container-fluid py-3">
  <div class="row">

    <!-- ================= CALENDAR ================= -->
    <div class="col-lg-8 mb-3">
      <div class="card">

        <div class="card-header d-flex justify-content-between align-items-center">
          <h3 class="mb-0">Course calendar</h3>

          <div class="d-flex align-items-center gap-2">
            <a href="{{ url_for('assignments.bulk_returns') }}"
               class="btn btn-sm btn-tams-primary">
              Return cards
            </a>

            {% set actor_role = (current_user.role or '')|lower|trim %}
            {% set actor_dept = (current_user.department or '')|lower|trim %}
            {% if actor_role == 'admin' or actor_dept == 'itc support' or actor_role.startswith('itc') %}
              <a href="{{ url_for('courses.return_pcs') }}"
                 class="btn btn-sm btn-tams-primary">
                Return PCs
              </a>
            {% endif %}
          </div>
        </div>

        <div class="card-body">
          <div id="calendar" style="min-height: 500px;"></div>
        </div>
      </div>

      <!-- MODAL -->
      <div class="modal fade" id="courseModal" tabindex="-1">
        <div class="modal-dialog modal-lg modal-dialog-centered">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title">Course details</h5>
              <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="courseModalBody">
              <div class="text-center py-5">
                <div class="spinner-border"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ================= RIGHT COLUMN ================= -->
    <div class="col-lg-4 mb-3">

      <!-- DEVICES (sin auto-refresh) -->
      <div class="col-8 mb-3">
        <div class="accordion" id="devicesAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button bg-devices"
                      data-bs-toggle="collapse"
                      data-bs-target="#devicesCollapse">
                Devices
              </button>
            </h2>
            <div id="devicesCollapse" class="accordion-collapse collapse show">
              <div class="accordion-body">

                {% if device_stats %}
                  <div class="table-responsive">
                    <table class="table table-sm mb-0">
                      <thead>
                        <tr>
                          <th>Type</th>
                          <th class="text-center">Loan</th>
                          <th class="text-center">% Use</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for row in device_stats %}
                          {% set raw = row.type or "unknown" %}
                          {% set label = {
                            'card_canteen': 'Canteen',
                            'card_guest': 'Guest',
                            'card_instructor': 'Instructor',
                            'card_vending': 'Vending',
                            'laptop': 'Laptop'
                          }.get(raw, raw|capitalize) %}
                          {% set color = {
                            'card_canteen': 'success',
                            'card_guest': 'secondary',
                            'card_instructor': 'warning',
                            'card_vending': 'primary',
                            'laptop': 'info'
                          }.get(raw, 'light') %}
                          <tr>
                            <td><span class="badge text-bg-{{ color }}">{{ label }}</span></td>
                            <td class="text-center">{{ row.assigned }}/{{ row.total }}</td>
                            <td class="text-center">{{ row.ratio|round(0) }}%</td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <p class="text-muted text-center mb-0">No devices registered.</p>
                {% endif %}

                <div class="text-center mt-3">
                  <a href="{{ url_for('devices.index') }}" class="small">View all</a>
                </div>

              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ALERTS (AUTO-REFRESHED) -->
      <div class="col-12 mb-3">
        <div id="alerts-accordion-container">
          {% include "partials/_alerts_accordion.html" %}
        </div>
      </div>

      <!-- ITC PICKUP -->
      {% if (current_user.department or '')|trim == 'TCO' %}
      <div class="col-8 mb-3">
        <div class="accordion" id="pickupAccordion">
          <div class="accordion-item">
            <h2 class="accordion-header">
              <button class="accordion-button bg-alerts"
                      data-bs-toggle="collapse"
                      data-bs-target="#pickupCollapse">
                ITC pickup
              </button>
            </h2>
            <div id="pickupCollapse" class="accordion-collapse collapse show">
              <div class="accordion-body">
                <form method="post" action="{{ url_for('courses.notify_itc_pickup') }}">
                  <input type="text"
                         class="form-control form-control-sm"
                         name="pickup_note"
                         placeholder="Equipment ready for pickup">
                  <button class="btn btn-sm btn-primary mt-3 w-100">
                    Notify ITC
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}

<script>
/* ================= MODAL ================= */
function loadCourseDetail(url) {
  fetch(url, { credentials: "same-origin" })
    .then(r => r.text())
    .then(html => {
      document.getElementById("courseModalBody").innerHTML = html;
      bootstrap.Modal.getOrCreateInstance(
        document.getElementById("courseModal")
      ).show();
    });
}

/* ================= CALENDAR ================= */
document.addEventListener('DOMContentLoaded', function () {
  const calendarEl = document.getElementById('calendar');
  if (!calendarEl) return;

  const calendar = new FullCalendar.Calendar(calendarEl, {
    initialView: 'dayGridMonth',
    locale: 'en',
    firstDay: 1,
    height: 'auto',

    headerToolbar: {
      left: 'prev,next today',
      center: 'title',
      right: 'dayGridMonth,timeGridWeek,listWeek'
    },

    // opcional: nombres m√°s humanos
    buttonText: {
      today: 'Today',
      month: 'Month',
      week: 'Week',
      list: 'List'
    },

    events: "{{ url_for('courses.api_calendar_events') }}",

    eventClick: function (info) {
      const detailUrl = info.event.extendedProps.detail_url;
      if (detailUrl) {
        info.jsEvent.preventDefault();
        loadCourseDetail(detailUrl);
      }
    }
  });

  calendar.render();
});

/* ================= AUTO REFRESH ================= */
(function autoRefreshDashboard() {
  const INTERVAL = 20000;
  let busy = false;

  async function refreshAlerts() {
    const host = document.getElementById("alerts-accordion-container");
    if (!host) return;

    const r = await fetch("/dashboard/partials/alerts", {
      credentials: "same-origin",
      headers: { "Accept": "text/html", "X-Requested-With": "fetch" }
    });

    if (!r.ok) throw new Error("alerts HTTP " + r.status);

    const html = await r.text();
    if (html.includes("<html")) throw new Error("alerts returned full page");

    host.innerHTML = html;
  }

  async function tick() {
    if (busy) return schedule();
    busy = true;

    try {
      await refreshAlerts();
      if (window.dashboardCalendar) {
        window.dashboardCalendar.refetchEvents();
      }
    } catch (e) {
      console.error("Dashboard refresh failed:", e);
    } finally {
      busy = false;
      schedule();
    }
  }

  function schedule() {
    setTimeout(tick, document.hidden ? 60000 : INTERVAL);
  }

  setTimeout(tick, 1000);
})();
</script>

<script>
/* ================= ITC PICKUP ================= */
(function () {
  const el = document.getElementById("itc-pickup-container");
  if (!el) return;

  async function tick() {
    try {
      const r = await fetch("{{ url_for('main.dashboard_itc_pickup_fragment') }}",
        { credentials: "same-origin" });
      if (r.ok) {
        const html = await r.text();
        if (!html.includes("<html")) el.innerHTML = html;
      }
    } finally {
      setTimeout(tick, document.hidden ? 60000 : 20000);
    }
  }

  tick();
})();
</script>

{% endblock %}
