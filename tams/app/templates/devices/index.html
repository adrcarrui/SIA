{% extends "base.html" %}
{% block content %}

<div class="devices-page">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Devices</h2>
    <a class="btn btn-sm btn-primary" href="{{ url_for('devices.new_device') }}">New device</a>
  </div>

  <p class="text-muted mb-2">
    Total devices: {{ "{:,}".format(total or 0) }}
  </p>

  <form method="get" action="{{ url_for('devices.index') }}" class="devices-panel">
    <input type="hidden" name="q" value="{{ q or '' }}">
    <input type="hidden" name="page" value="1">
    <input type="hidden" name="per_page" value="{{ per_page }}">

    <!-- ================= FIXED HEADER (2 ROWS) ================= -->
    <div class="devices-header-2rows" id="devicesHeader">

      <!-- Row 1: column names -->
      <div class="devices-grid-cols devices-grid-cols-head">
        <div class="devices-th text-center fw-bold">#</div>
        <div class="devices-th text-center fw-bold">Name</div>
        <div class="devices-th text-center fw-bold">Identifier</div>
        <div class="devices-th text-center fw-bold">Root type</div>
        <div class="devices-th text-center fw-bold">Subtype</div>
        <div class="devices-th text-center fw-bold">Status</div>
        <div class="devices-th text-center fw-bold">Notes</div>
        <div class="devices-th text-center fw-bold">Actions</div>
      </div>

      <!-- Row 2: filters -->
      <div class="devices-grid-cols devices-grid-cols-filters">

        <!-- # (no filter) -->
        <div></div>

        <!-- Name -->
        <div>
          <input type="text"
                 class="form-control form-control-sm"
                 name="name"
                 placeholder="Name"
                 value="{{ filter_name or '' }}">
        </div>

        <!-- Identifier -->
        <div class="text-center">
          <input type="text"
                 class="form-control form-control-sm"
                 name="identifier"
                 placeholder="UID / BARCODE"
                 value="{{ filter_identifier or '' }}">
        </div>

        <!-- Root type -->
        <div class="text-center">
          <select id="root_type_id" name="root_type_id" class="form-select form-select-sm">
            <option value="">All</option>
            {% for r in roots %}
              <option value="{{ r.id }}"
                {{ 'selected' if (filter_root_type_id|string) == (r.id|string) else '' }}>
                {{ r.name }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Subtype -->
        <div class="text-center">
          <select id="asset_type_id" name="asset_type_id" class="form-select form-select-sm">
            <option value="">All</option>
          </select>
        </div>

        <!-- Status -->
        <div class="text-center">
          <select name="status" class="form-select form-select-sm">
            <option value="">All</option>
            {% for s in DEVICE_STATUSES %}
              <option value="{{ s }}"
                {{ 'selected' if filter_status == s else '' }}>
                {{ s }}
              </option>
            {% endfor %}
          </select>
        </div>

        <!-- Notes -->
        <div>
          <input type="text"
                 class="form-control form-control-sm"
                 name="notes"
                 placeholder="Notes"
                 value="{{ filter_notes or '' }}">
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2 text-center">
          <button type="submit" class="btn btn-primary btn-sm">Filter</button>
          <a href="{{ url_for('devices.index') }}" class="btn btn-secondary btn-sm">Clear</a>
        </div>

      </div>
    </div>

    <!-- ================= TABLE BODY (SCROLL ONLY HERE) ================= -->
    <div class="devices-table-scroll" id="devicesScroll">
      <div class="table-responsive">
        <table class="table table-sm align-middle mb-0 devices-table-fixed">

          <!-- Force SAME column widths -->
          <colgroup>
            <col class="col-num">
            <col class="col-name">
            <col class="col-ident">
            <col class="col-root">
            <col class="col-sub">
            <col class="col-status">
            <col class="col-notes">
            <col class="col-actions">
          </colgroup>

          <tbody>
            {% for d in devices %}
              {% set root_name = (d.asset_type.parent.name if d.asset_type and d.asset_type.parent else None) %}
              {% set sub_name  = (d.asset_type.name if d.asset_type else None) %}
              {% set req_rfid = (d.asset_type.requires_rfid if d.asset_type else False) %}
              {% set req_bar  = (d.asset_type.requires_barcode if d.asset_type else False) %}

              {# Decide qué enseñar en la columna Identifier #}
              {% set ident_label = '' %}
              {% set ident_value = '' %}
              {% if req_rfid and d.uid %}
                {% set ident_label = 'UID' %}
                {% set ident_value = d.uid %}
              {% elif req_bar and d.barcode %}
                {% set ident_label = 'BARCODE' %}
                {% set ident_value = d.barcode %}
              {% elif d.uid %}
                {% set ident_label = 'UID' %}
                {% set ident_value = d.uid %}
              {% elif d.barcode %}
                {% set ident_label = 'BARCODE' %}
                {% set ident_value = d.barcode %}
              {% endif %}

              <tr>
                <!-- # -->
                <td class="text-muted text-center">
                  {{ ((page - 1) * per_page) + loop.index }}
                </td>

                <!-- Name -->
                <td class="text-muted text-center fw-bold">{{ d.name or '—' }}</td>

                <!-- Identifier -->
                <td class="text-center text-muted">
                  {% if ident_value %}
                    <span class="small fw-semibold">{{ ident_label }}:</span>
                    <span class="small">{{ ident_value }}</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <!-- Root type -->
                <td class="text-center">
                  {% if root_name %}
                    <span class="badge bg-info text-dark">{{ root_name }}</span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <!-- Subtype -->
                <td class="text-center">
                  {% if sub_name %}
                    <span class="badge bg-light text-dark border">{{ sub_name }}</span>
                    <span class="ms-2 small text-muted">
                      {% if req_rfid %}<span class="badge bg-secondary">RFID</span>{% endif %}
                      {% if req_bar %}<span class="badge bg-secondary">BARCODE</span>{% endif %}
                    </span>
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </td>

                <!-- Status -->
                <td class="text-center">
                  {% set skey = (d.status or '')|lower|trim %}
                  {% set scolor = {
                    'assigned':'primary',
                    'available':'success',
                    'lost':'danger',
                    'annulled':'secondary'
                  }.get(skey, 'secondary') %}
                  <span class="badge bg-{{ scolor }}">{{ d.status or '—' }}</span>
                </td>

                <!-- Notes -->
                <td class="text-center">{{ d.notes or '' }}</td>

                <!-- Actions -->
                <td class="text-end text-center">
                  <a class="btn btn-secondary btn-sm"
                     href="{{ url_for('devices.edit_device', device_id=d.id) }}">
                    Edit
                  </a>
                  <button
                    type="submit"
                    class="btn btn-sm btn-danger"
                    formmethod="post"
                    formaction="{{ url_for('devices.delete_device', device_id=d.id) }}"
                    onclick="return confirm('Delete device {{ d.id }}?')"
                  >
                    Delete
                  </button>
                </td>
              </tr>
            {% else %}
              <tr>
                <td colspan="8" class="text-center text-muted py-4">
                  No devices.
                </td>
              </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>

  </form>

  <!-- ================= PAGINATION ================= -->
  <nav aria-label="Pagination" class="mt-3">
    <ul class="pagination mb-2">
      <li class="page-item {% if not has_prev %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('devices.index',
             q=q,
             page=(page-1 if page>1 else 1),
             per_page=per_page,
             name=filter_name,
             identifier=filter_identifier,
             root_type_id=filter_root_type_id,
             asset_type_id=filter_asset_type_id,
             status=filter_status,
             notes=filter_notes) }}">«</a>
      </li>
      <li class="page-item active">
        <span class="page-link">{{ page }}</span>
      </li>
      <li class="page-item {% if not has_next %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('devices.index',
             q=q,
             page=(page+1 if has_next else page),
             per_page=per_page,
             name=filter_name,
             identifier=filter_identifier,
             root_type_id=filter_root_type_id,
             asset_type_id=filter_asset_type_id,
             status=filter_status,
             notes=filter_notes) }}">»</a>
      </li>
    </ul>
  </nav>

  <!-- ================= EXPORTS ================= -->
  <div class="d-flex justify-content-between align-items-center">
    <div></div>
    <div class="d-flex align-items-center gap-2">
      <span class="small text-muted fw-bold me-1">Download as:</span>
      <div class="btn-group btn-group-sm">
        <a class="btn btn-outline-secondary"
           href="{{ url_for('devices.export_devices',
             format='csv', q=q, name=filter_name, identifier=filter_identifier,
             root_type_id=filter_root_type_id, asset_type_id=filter_asset_type_id,
             status=filter_status, notes=filter_notes,
             page=page, per_page=per_page) }}">CSV</a>
        <a class="btn btn-outline-secondary"
           href="{{ url_for('devices.export_devices',
             format='xlsx', q=q, name=filter_name, identifier=filter_identifier,
             root_type_id=filter_root_type_id, asset_type_id=filter_asset_type_id,
             status=filter_status, notes=filter_notes,
             page=page, per_page=per_page) }}">Excel</a>
        <a class="btn btn-outline-secondary"
           href="{{ url_for('devices.export_devices',
             format='pdf', q=q, name=filter_name, identifier=filter_identifier,
             root_type_id=filter_root_type_id, asset_type_id=filter_asset_type_id,
             status=filter_status, notes=filter_notes,
             page=page, per_page=per_page) }}">PDF</a>
      </div>
    </div>
  </div>

</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  document.body.classList.add("no-page-scroll");

  const childrenMap = {{ children_map|tojson }};
  const rootSelect = document.getElementById("root_type_id");
  const childSelect = document.getElementById("asset_type_id");

  const selectedSubtype = {{ (filter_asset_type_id if filter_asset_type_id else '')|tojson }};
  const selectedRoot = {{ (filter_root_type_id if filter_root_type_id else '')|tojson }};

  function allChildrenFlat() {
    const all = [];
    for (const [rootId, arr] of Object.entries(childrenMap || {})) {
      for (const c of (arr || [])) all.push({ rootId, ...c });
    }
    return all;
  }

  function deduceRootFromSubtype(subtypeId) {
    if (!subtypeId) return "";
    const all = allChildrenFlat();
    const found = all.find(x => String(x.id) === String(subtypeId));
    return found ? String(found.rootId) : "";
  }

  function refillSubtypeOptions(rootId) {
    childSelect.innerHTML = '<option value="">All</option>';
    const list = rootId ? (childrenMap[String(rootId)] || []) : allChildrenFlat();
    for (const c of list) {
      const opt = document.createElement("option");
      opt.value = c.id;
      opt.textContent = c.name;
      if (selectedSubtype && String(opt.value) === String(selectedSubtype)) {
        opt.selected = true;
      }
      childSelect.appendChild(opt);
    }
  }

  if (!rootSelect || !childSelect) return;

  if ((!selectedRoot || String(selectedRoot) === "") && selectedSubtype) {
    const guessed = deduceRootFromSubtype(selectedSubtype);
    if (guessed) rootSelect.value = guessed;
  }

  rootSelect.addEventListener("change", function () {
    childSelect.value = "";
    refillSubtypeOptions(rootSelect.value || "");
  });

  refillSubtypeOptions(rootSelect.value || "");
});
</script>

{% endblock %}
