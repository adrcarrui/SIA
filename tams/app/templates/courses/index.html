{% extends "base.html" %}
{% block content %}

{# Permisos: Admin o ITC support (cualquier variante que contenga "itc") #}
{% set role_l = (current_user.role or '')|lower %}
{% set dept_l = (current_user.department or '')|lower %}
{% set can_assign_pcs = ('admin' in role_l) or ('itc' in dept_l) %}
{% set can_edit_itc_status = ('admin' in role_l) or ('itc' in dept_l) or role_l.startswith('itc') %}

{# TCO: NO quitamos columnas, solo colapsamos ITC por CSS con la clase no-itc #}
{% set show_itc_column = dept_l != 'tco' %}

{# ================= SORT STATE =================
   sort: none |
         course_desc course_asc |
         name_desc name_asc |
         start_desc start_asc |
         end_desc end_asc
   Tri-estado por columna:
   none -> *_desc -> *_asc -> none
#}
{% set current_sort = sort or (request.args.get('sort') or 'none') %}

{% set is_course_sort = current_sort.startswith('course') %}
{% set is_name_sort   = current_sort.startswith('name') %}
{% set is_start_sort  = current_sort.startswith('start') %}
{% set is_end_sort    = current_sort.startswith('end') %}

{# next sort per column #}
{% if is_course_sort and current_sort.endswith('desc') %}
  {% set next_course_sort = 'course_asc' %}
{% elif is_course_sort and current_sort.endswith('asc') %}
  {% set next_course_sort = 'none' %}
{% else %}
  {% set next_course_sort = 'course_desc' %}
{% endif %}

{% if is_name_sort and current_sort.endswith('desc') %}
  {% set next_name_sort = 'name_asc' %}
{% elif is_name_sort and current_sort.endswith('asc') %}
  {% set next_name_sort = 'none' %}
{% else %}
  {% set next_name_sort = 'name_desc' %}
{% endif %}

{% if is_start_sort and current_sort.endswith('desc') %}
  {% set next_start_sort = 'start_asc' %}
{% elif is_start_sort and current_sort.endswith('asc') %}
  {% set next_start_sort = 'none' %}
{% else %}
  {% set next_start_sort = 'start_desc' %}
{% endif %}

{% if is_end_sort and current_sort.endswith('desc') %}
  {% set next_end_sort = 'end_asc' %}
{% elif is_end_sort and current_sort.endswith('asc') %}
  {% set next_end_sort = 'none' %}
{% else %}
  {% set next_end_sort = 'end_desc' %}
{% endif %}

{# arrows #}
{% set course_arrow = '' %}
{% if is_course_sort and current_sort.endswith('desc') %}{% set course_arrow = ' ▲' %}{% endif %}
{% if is_course_sort and current_sort.endswith('asc')  %}{% set course_arrow = ' ▼' %}{% endif %}

{% set name_arrow = '' %}
{% if is_name_sort and current_sort.endswith('desc') %}{% set name_arrow = ' ▲' %}{% endif %}
{% if is_name_sort and current_sort.endswith('asc')  %}{% set name_arrow = ' ▼' %}{% endif %}

{% set start_arrow = '' %}
{% if is_start_sort and current_sort.endswith('desc') %}{% set start_arrow = ' ▲' %}{% endif %}
{% if is_start_sort and current_sort.endswith('asc')  %}{% set start_arrow = ' ▼' %}{% endif %}

{% set end_arrow = '' %}
{% if is_end_sort and current_sort.endswith('desc') %}{% set end_arrow = ' ▲' %}{% endif %}
{% if is_end_sort and current_sort.endswith('asc')  %}{% set end_arrow = ' ▼' %}{% endif %}

<div class="courses-page
            {% if not show_itc_column %}no-itc{% endif %}
            {% if dept_l == 'tco' %}is-tco{% else %}is-itc{% endif %}">

  <div class="d-flex align-items-center justify-content-between mb-3">
    <h2 class="mb-0">Courses</h2>
    <div class="d-flex align-items-center gap-2">
      <a
        href="{{ url_for('courses.index', sort=current_sort) }}"
        class="btn btn-sm btn-outline-secondary {% if not filter_my %}active{% endif %}">
        All
      </a>

      <a
        href="{{ url_for('courses.index',
                         q=q,
                         course=filter_course,
                         name=filter_name,
                         client=filter_client,
                         status=filter_status,
                         trainees=filter_trainees,
                         notes=filter_notes,
                         start_date=filter_start_date,
                         end_date=filter_end_date,
                         sort=current_sort,
                         my=1) }}"
        class="btn btn-primary btn-sm {% if filter_my == '1' %}active{% endif %}">
        My Courses
      </a>

      <a class="btn btn-sm btn-primary" href="{{ url_for('courses.new_course') }}">New course</a>
    </div>
  </div>

  <form method="get" action="{{ url_for('courses.index') }}" class="courses-panel">
    {# mantener búsqueda global y resetear página al filtrar #}
    <input type="hidden" name="q" value="{{ q or '' }}">
    <input type="hidden" name="page" value="1">
    <input type="hidden" name="per_page" value="{{ per_page }}">
    {# mantener el toggle my #}
    <input type="hidden" name="my" value="{{ filter_my or '' }}">
    {# mantener sort actual al filtrar #}
    <input type="hidden" name="sort" value="{{ current_sort }}">

    <!-- ================= FIXED HEADER (2 ROWS) ================= -->
    <div class="courses-header-2rows" id="coursesHeader">

      <!-- Row 1: column names -->
      <div class="courses-grid-cols courses-grid-cols-head">
        <div class="courses-th text-center fw-bold">#</div>

        <!-- COURSE sortable -->
        <div class="courses-th text-center fw-bold">
          <a class="text-decoration-none text-dark"
             href="{{ url_for('courses.index',
                              q=q,
                              page=1,
                              per_page=per_page,
                              my=filter_my,
                              sort=next_course_sort,
                              course=filter_course,
                              name=filter_name,
                              client=filter_client,
                              status=filter_status,
                              trainees=filter_trainees,
                              notes=filter_notes,
                              start_date=filter_start_date,
                              end_date=filter_end_date) }}">
            Course{{ course_arrow }}
          </a>
        </div>

        <!-- NAME sortable -->
        <div class="courses-th text-center fw-bold">
          <a class="text-decoration-none text-dark"
             href="{{ url_for('courses.index',
                              q=q,
                              page=1,
                              per_page=per_page,
                              my=filter_my,
                              sort=next_name_sort,
                              course=filter_course,
                              name=filter_name,
                              client=filter_client,
                              status=filter_status,
                              trainees=filter_trainees,
                              notes=filter_notes,
                              start_date=filter_start_date,
                              end_date=filter_end_date) }}">
            Name{{ name_arrow }}
          </a>
        </div>

        <div class="courses-th text-center fw-bold">Client</div>

        <!-- START sortable -->
        <div class="courses-th text-center fw-bold">
          <a class="text-decoration-none text-dark"
             href="{{ url_for('courses.index',
                              q=q,
                              page=1,
                              per_page=per_page,
                              my=filter_my,
                              sort=next_start_sort,
                              course=filter_course,
                              name=filter_name,
                              client=filter_client,
                              status=filter_status,
                              trainees=filter_trainees,
                              notes=filter_notes,
                              start_date=filter_start_date,
                              end_date=filter_end_date) }}">
            Start{{ start_arrow }}
          </a>
        </div>

        <!-- END sortable -->
        <div class="courses-th text-center fw-bold">
          <a class="text-decoration-none text-dark"
             href="{{ url_for('courses.index',
                              q=q,
                              page=1,
                              per_page=per_page,
                              my=filter_my,
                              sort=next_end_sort,
                              course=filter_course,
                              name=filter_name,
                              client=filter_client,
                              status=filter_status,
                              trainees=filter_trainees,
                              notes=filter_notes,
                              start_date=filter_start_date,
                              end_date=filter_end_date) }}">
            End{{ end_arrow }}
          </a>
        </div>

        <div class="courses-th text-center fw-bold">Status</div>

        {# SIEMPRE existe ITC. Para TCO se colapsa por CSS #}
        <div class="courses-th text-center fw-bold courses-itc-cell">
          <span class="courses-itc-inner">ITC Status</span>
        </div>

        <div class="courses-th text-center fw-bold">Notes</div>
        <div class="courses-th text-center fw-bold">Actions</div>
      </div>

      <!-- Row 2: filters -->
      <div class="courses-grid-cols courses-grid-cols-filters">

        <!-- # (no filter) -->
        <div></div>

        <!-- Course -->
        <div>
          <input type="text"
                class="form-control form-control-sm w-100"
                name="course"
                placeholder="Course"
                value="{{ filter_course or '' }}">
        </div>

        <!-- Name -->
        <div>
          <input type="text"
                class="form-control form-control-sm w-100"
                name="name"
                placeholder="Name"
                value="{{ filter_name or '' }}">
        </div>

        <!-- Client -->
        <div>
          <input type="text"
                class="form-control form-control-sm w-100"
                name="client"
                placeholder="Client"
                value="{{ filter_client or '' }}">
        </div>

        <!-- Start -->
        <div>
          <input type="date"
                 class="form-control form-control-sm w-100"
                 name="start_date"
                 value="{{ filter_start_date or '' }}">
        </div>

        <!-- End -->
        <div>
          <input type="date"
                 class="form-control form-control-sm w-100"
                 name="end_date"
                 value="{{ filter_end_date or '' }}">
        </div>

        <!-- Status -->
        <div>
          <select name="status" class="form-select form-select-sm w-100">
            <option value="">All</option>
            {% for st in COURSE_TCO_STATUSES %}
              <option value="{{ st }}" {% if filter_status == st %}selected{% endif %}>{{ st }}</option>
            {% endfor %}
          </select>
        </div>

        {# SIEMPRE existe ITC. Para TCO se colapsa por CSS #}
        <div class="text-center courses-itc-cell">
          <span class="text-muted small courses-itc-inner text-center">—</span>
        </div>

        <!-- Notes -->
        <div>
          <input type="text"
                class="form-control form-control-sm w-100"
                name="notes"
                placeholder="Notes"
                value="{{ filter_notes or '' }}">
        </div>

        <!-- Actions -->
        <div class="d-flex gap-2 justify-content-center">
          <button type="submit" class="btn btn-primary btn-sm">Filter</button>
          <a href="{{ url_for('courses.index') }}" class="btn btn-secondary btn-sm">Clear</a>
        </div>

      </div>
    </div>

    <!-- ================= TABLE BODY (SCROLL ONLY HERE) ================= -->
    <div class="courses-table-scroll" id="coursesScroll">
      <div class="courses-table-wrap">
        <table class="table table-sm align-middle mb-0 courses-table-fixed">

          <!-- Force SAME column widths as header grid -->
          <colgroup>
            <col style="width: var(--crs-col-num);">
            <col style="width: var(--crs-col-course);">
            <col style="width: var(--crs-col-name);">
            <col style="width: var(--crs-col-client);">
            <col style="width: var(--crs-col-start);">
            <col style="width: var(--crs-col-end);">
            <col style="width: var(--crs-col-status);">
            <col class="crs-col-itc" style="width: var(--crs-col-itc);">
            <col style="width: var(--crs-col-notes);">
            <col style="width: var(--crs-col-actions);">
          </colgroup>

          <tbody>
            {% for c in courses %}
            <tr data-course-row="{{ c.id }}">
              <td class="text-muted text-center">{{ ((page - 1) * per_page) + loop.index }}</td>

              <td class="text-truncate text-center" title="{{ c.course }}">{{ c.course or '—' }}</td>
              <td class="text-truncate text-center" title="{{ c.name }}">{{ c.name or '—' }}</td>
              <td class="text-truncate text-center" title="{{ c.client }}">{{ c.client or '—' }}</td>

              <td class="text-nowrap text-center">
                {{ c.start_date.strftime('%d-%m-%Y') if c.start_date is not none else '—' }}
              </td>

              <td class="text-nowrap text-center">
                {{ c.end_date.strftime('%d-%m-%Y') if c.end_date is not none else '—' }}
              </td>

              <td class="text-center">
                {% set status_color = {
                  'active':'success',
                  'finished':'secondary',
                  'lost':'warning',
                  'cancelled':'danger',
                  'planned':"dark"
                }.get((c.auto_status or '')|lower, 'light') %}
                <span class="badge text-bg-{{ status_color }}">{{ c.auto_status or '—' }}</span>
              </td>

              {# SIEMPRE existe ITC cell. Para TCO se colapsa por CSS #}
              <td class="courses-itc-cell">
                <div class="courses-itc-inner">
                  {% set current_itc = (c.status_itc if c.status_itc in (COURSE_ITC_STATUSES or []) else 'start') %}
                  {% if can_edit_itc_status %}
                    <div class="d-flex align-items-center gap-2">
                      <select class="form-select form-select-sm itc-status-select"
                              data-course-id="{{ c.id }}"
                              style="min-width: 140px;">
                        {% for st in (COURSE_ITC_STATUSES or []) %}
                          <option value="{{ st }}" {% if current_itc == st %}selected{% endif %}>{{ st }}</option>
                        {% endfor %}
                      </select>
                      <span class="small text-muted itc-status-msg" data-course-id="{{ c.id }}"></span>
                    </div>
                  {% else %}
                    <span class="badge text-bg-light">{{ current_itc }}</span>
                  {% endif %}
                </div>
              </td>

              <td class="text-truncate" title="{{ c.notes }}">
                {{ c.notes if c is defined and c.notes is not none else '' }}
              </td>

              <td>
                <div class="d-flex align-items-center gap-2 justify-content-center flex-wrap">
                  <a href="{{ url_for('assignments.new_bulk', course_id=c.id) }}"
                     class="btn btn-sm btn-primary">
                    Associate
                  </a>

                  {% set actor_role = (current_user.role or '')|lower %}
                  {% set actor_dept = (current_user.department or '')|trim %}
                  {% if actor_role == 'admin' or actor_dept == 'ITC support' %}
                    <a class="btn btn-sm btn-primary"
                       href="{{ url_for('courses.assign_pcs', course_id=c.id) }}">
                      Assign PCs
                    </a>
                  {% endif %}

                  <a href="{{ url_for('courses.edit_course', course_id=c.id) }}"
                     class="btn btn-secondary btn-sm">
                    Edit
                  </a>

                  <button
                    type="submit"
                    class="btn btn-danger btn-sm"
                    formmethod="post"
                    formaction="{{ url_for('courses.delete_course', course_id=c.id) }}"
                    onclick="return confirm('Delete course #{{ c.id }}?');"
                  >
                    Delete
                  </button>
                </div>
              </td>
            </tr>

            {% else %}
            <tr>
              <td colspan="10" class="text-center text-muted py-4">
                {% if q %}
                  No courses found for “{{ q }}”.
                {% else %}
                  No courses registered.
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>

        </table>
      </div>
    </div>

  </form>

  <!-- ================= PAGINATION ================= -->
  <nav aria-label="Pagination" class="mt-3">
    <ul class="pagination mb-2">
      <li class="page-item {% if not has_prev %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('courses.index',
                            q=q,
                            page=(page-1 if page>1 else 1),
                            per_page=per_page,
                            sort=current_sort,
                            course=filter_course,
                            name=filter_name,
                            client=filter_client,
                            status=filter_status,
                            trainees=filter_trainees,
                            start_date=filter_start_date,
                            end_date=filter_end_date,
                            notes=filter_notes,
                            my=filter_my) }}">«</a>
      </li>
      <li class="page-item active"><span class="page-link">{{ page }}</span></li>
      <li class="page-item {% if not has_next %}disabled{% endif %}">
        <a class="page-link"
           href="{{ url_for('courses.index',
                            q=q,
                            page=(page+1 if has_next else page),
                            per_page=per_page,
                            sort=current_sort,
                            course=filter_course,
                            name=filter_name,
                            client=filter_client,
                            status=filter_status,
                            trainees=filter_trainees,
                            start_date=filter_start_date,
                            end_date=filter_end_date,
                            notes=filter_notes,
                            my=filter_my) }}">»</a>
      </li>
    </ul>
  </nav>

  <!-- ================= EXPORTS ================= -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <div></div>
    <div class="d-flex align-items-center gap-2">
      <span class="small fw-bold me-1">Download as:</span>

      <div class="btn-group btn-group-sm" role="group">
        <a class="btn btn-outline-secondary"
           href="{{ url_for('courses.export_courses',
                            format='csv',
                            q=q,
                            course=filter_course,
                            name=filter_name,
                            client=filter_client,
                            status=filter_status,
                            trainees=filter_trainees,
                            notes=filter_notes,
                            start_date=filter_start_date,
                            end_date=filter_end_date,
                            page=page,
                            per_page=per_page,
                            my=filter_my) }}">CSV</a>

        <a class="btn btn-outline-secondary"
           href="{{ url_for('courses.export_courses',
                            format='xlsx',
                            q=q,
                            course=filter_course,
                            name=filter_name,
                            client=filter_client,
                            status=filter_status,
                            trainees=filter_trainees,
                            notes=filter_notes,
                            start_date=filter_start_date,
                            end_date=filter_end_date,
                            page=page,
                            per_page=per_page,
                            my=filter_my) }}">Excel</a>

        <a class="btn btn-outline-secondary"
           href="{{ url_for('courses.export_courses',
                            format='pdf',
                            q=q,
                            course=filter_course,
                            name=filter_name,
                            client=filter_client,
                            status=filter_status,
                            trainees=filter_trainees,
                            notes=filter_notes,
                            start_date=filter_start_date,
                            end_date=filter_end_date,
                            page=page,
                            per_page=per_page,
                            my=filter_my) }}">PDF</a>
      </div>
    </div>
  </div>

</div>

<!-- ===== Scrollbar compensation (header aligns with table body) ===== -->
<script>
document.addEventListener("DOMContentLoaded", () => {
  const scroll = document.getElementById("coursesScroll");
  if (!scroll) return;

  function syncScrollbarPad(){
    const sbw = scroll.offsetWidth - scroll.clientWidth; // scrollbar width
    document.documentElement.style.setProperty("--crs-scrollbar-pad", sbw + "px");
  }

  syncScrollbarPad();
  window.addEventListener("resize", syncScrollbarPad);
});
</script>

{# JS inline para guardar status_itc (solo interesa cuando NO es TCO) #}
{% if show_itc_column %}
<script>
(function () {
  const selects = document.querySelectorAll(".itc-status-select");

  function setMsg(courseId, text, isError=false) {
    const el = document.querySelector('.itc-status-msg[data-course-id="' + courseId + '"]');
    if (!el) return;
    el.textContent = text || "";
    el.classList.toggle("text-danger", !!isError);
    el.classList.toggle("text-muted", !isError);
  }

  selects.forEach(sel => {
    sel.dataset.oldValue = sel.value;
    sel.dataset.saving = "0";

    sel.addEventListener("change", async () => {
      const courseId = sel.dataset.courseId;
      const newVal = sel.value;

      if (sel.dataset.saving === "1") {
        sel.value = sel.dataset.oldValue || sel.value;
        return;
      }

      const oldVal = sel.dataset.oldValue || "";

      if (newVal === oldVal) {
        setMsg(courseId, "");
        return;
      }

      sel.dataset.saving = "1";
      sel.disabled = true;
      setMsg(courseId, "Saving...");

      try {
        const resp = await fetch(`/courses/api/course/${courseId}/itc-status`, {
          method: "POST",
          headers: {
              "Content-Type": "application/json",
              "X-Requested-With": "XMLHttpRequest"
            },
          body: JSON.stringify({ status_itc: newVal })
        });

        const data = await resp.json().catch(() => ({}));

        if (!resp.ok || !data.success) {
          const err = (data && data.error) ? data.error : "Error";
          setMsg(courseId, err, true);
          sel.value = oldVal;
          return;
        }

        sel.dataset.oldValue = newVal;
        setMsg(courseId, "Saved");
        setTimeout(() => setMsg(courseId, ""), 1200);

      } catch (e) {
        setMsg(courseId, "Network error", true);
        sel.value = oldVal;
      } finally {
        sel.disabled = false;
        sel.dataset.saving = "0";
      }
    });
  });
})();
</script>
{% endif %}

{% endblock %}
