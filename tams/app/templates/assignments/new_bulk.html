{% extends "base.html" %}

{% block content %}
<div class="container py-3">
  <h4 class="mb-3">Associate devices to course</h4>

  <form method="post" id="bulk-assign-form">
    {% if csrf_token is defined %}
      {{ csrf_token() }}
    {% endif %}

    <!-- Curso -->
    <div class="mb-3">
      <label class="form-label">Course</label>
      <input type="text" class="form-control"
             value="{{ course.course or course.name or ('Course #' ~ course.id) }}"
             readonly>
      <input type="hidden" name="course_id" value="{{ course.id }}">
    </div>

    <!-- BotÃ³n NFC + estado -->
    <div class="mb-3 d-flex align-items-center gap-3">
      <button type="button" id="btn-read-uid" class="btn btn-primary btn-sm" disabled>
        <span id="btn-read-icon">ðŸ“¡</span>
        <span>Reading cardsâ€¦</span>
      </button>
      <small id="uid-status" class="text-muted">
        Approach cards to the reader. New cards will be added automatically.
      </small>
    </div>

    <!-- Tabla de devices -->
    <div class="table-responsive mb-3">
      <table class="table table-sm align-middle mb-0">
        <thead>
          <tr>
            <th>#</th>
            <th>Device name</th>
            <th>UID</th>
            <th class="text-end">Actions</th>
          </tr>
        </thead>
        <tbody id="devices-table-body">
          <!-- Filas generadas por JS al leer tarjetas -->
        </tbody>
      </table>
    </div>

    <div class="d-flex justify-content-between mt-3">
      <a href="{{ url_for('main.index') }}" class="btn btn-secondary">
        Cancel
      </a>
      <button type="submit" class="btn btn-primary" id="submit-btn">
        Save selected cards
      </button>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function () {
  console.log("assignments bulk NFC JS cargado (auto-poll)");

  const btn    = document.getElementById("btn-read-uid");
  const status = document.getElementById("uid-status");
  const icon   = document.getElementById("btn-read-icon");
  const tbody  = document.getElementById("devices-table-body");
  const submit = document.getElementById("submit-btn");
  const form   = document.getElementById("bulk-assign-form");

  if (!btn || !status || !icon || !tbody || !submit || !form) {
    console.warn("Elementos NFC (assignments bulk) no encontrados en el DOM");
    return;
  }

  // Para evitar duplicados
  const addedUids = new Set();
  let polling = true;
  const POLL_DELAY_MS = 1000;  // 1s entre lecturas

  // Local agent endpoint (runs on each client PC)
  const AGENT_UID_URL = "http://127.0.0.1:8765/uid";

  function refreshSubmitState() {
    const anyChecked = !!tbody.querySelector('input.row-selector:checked');
    submit.disabled = !anyChecked;
  }

  function addRowFromUid(data) {
    console.log("addRowFromUid data:", data);

    const uid = data.uid;
    if (!uid) {
      status.classList.remove("text-success", "text-muted", "text-warning");
      status.classList.add("text-danger");
      status.textContent = "Response without valid UID.";
      return;
    }

    if (addedUids.has(uid)) {
      console.log("UID duplicado ignorado:", uid);
      return;
    }

    addedUids.add(uid);

    const rowIndex = tbody.rows.length + 1;
    const tr = document.createElement("tr");

    // AquÃ­ va el nombre real del dispositivo si el backend lo manda en data.device_name
    const deviceName = data.device_name || ("Device for UID " + uid);
    const deviceId   = data.device_id || "";

    tr.innerHTML = `
      <td>${rowIndex}</td>
      <td>${deviceName}</td>
      <td>${uid}</td>
      <td class="text-end">
        <input type="checkbox" class="form-check-input row-selector me-2" checked>
        <button type="button" class="btn btn-sm btn-outline-danger btn-remove-device">
          Remove
        </button>
        <input type="hidden" name="uids[]" value="${uid}">
        ${deviceId ? `<input type="hidden" name="device_ids[]" value="${deviceId}">` : ""}
      </td>
    `;

    tbody.appendChild(tr);
    refreshSubmitState();

    status.classList.remove("text-danger", "text-muted", "text-warning");
    status.classList.add("text-success");
    status.textContent = "Card added: " + uid;
  }

  // Cambio en los checkboxes de selecciÃ³n
  tbody.addEventListener("change", function (ev) {
    if (!ev.target.classList.contains("row-selector")) return;
    refreshSubmitState();
  });

  // Antes de enviar, deshabilitamos los inputs de las filas no seleccionadas
  form.addEventListener("submit", function () {
    const rows = tbody.querySelectorAll("tr");
    rows.forEach((row) => {
      const checkbox = row.querySelector("input.row-selector");
      const inputs = row.querySelectorAll('input[name="uids[]"], input[name="device_ids[]"]');
      const disabled = checkbox && !checkbox.checked;
      inputs.forEach((inp) => {
        inp.disabled = disabled;
      });
    });
  });

  // DelegaciÃ³n para los botones "Remove"
  tbody.addEventListener("click", function (ev) {
    if (!ev.target.classList.contains("btn-remove-device")) return;

    const tr = ev.target.closest("tr");
    if (!tr) return;

    const uidInput = tr.querySelector('input[name="uids[]"]');
    if (uidInput) {
      addedUids.delete(uidInput.value);
    }

    tr.remove();

    // Renumerar filas
    Array.from(tbody.rows).forEach((row, idx) => {
      row.cells[0].textContent = idx + 1;
    });

    refreshSubmitState();
  });

  async function readOnce() {
    if (!polling) return;

    icon.textContent = "âŒ›";
    status.classList.remove("text-danger");
    if (!status.classList.contains("text-success")) {
      status.classList.add("text-muted");
      status.textContent = "Waiting for cardâ€¦";
    }

    try {
      // 1) Read from local agent
      const aResp = await fetch(AGENT_UID_URL, { method: "GET", cache: "no-store" });
      const aData = await aResp.json().catch(() => ({}));

      if (!aData || aData.success !== true || !aData.uid) {
        if (aData && aData.reason === "no_card") {
          // silent
        } else if (aData && aData.reason === "agent_error") {
          status.classList.remove("text-muted", "text-success", "text-warning");
          status.classList.add("text-danger");
          status.textContent = aData.error || "NFC agent error.";
        }
        return;
      }

      // 2) Send UID to server (normalize/resolve)
      const resp = await fetch("{{ url_for('users.read_uid_once') }}", {
        method: "POST",
        headers: {
          "X-Requested-With": "XMLHttpRequest",
          "Content-Type": "application/json"
        },
        body: JSON.stringify({ uid: aData.uid })
      });

      const data = await resp.json().catch(() => ({}));
      console.log("Respuesta NFC assignments:", data);

      if (data.success) {
        addRowFromUid(data);
      } else {
        if (data.reason && data.reason !== "no_card") {
          status.classList.remove("text-muted", "text-success", "text-warning");
          status.classList.add("text-danger");

          if (data.reason === "nfc_unavailable") {
            status.textContent = "NFC not available on server.";
          } else if (data.reason === "reader_error") {
            status.textContent = data.error || "NFC reader error.";
          } else {
            status.textContent = data.error || "Could not read card.";
          }
        }
      }
    } catch (e) {
      console.error("Error fetch NFC (assignments):", e);
      status.classList.remove("text-muted", "text-success", "text-warning");
      status.classList.add("text-danger");
      status.textContent = "Communication error with server.";
    } finally {
      icon.textContent = "ðŸ“¡";
      if (polling) {
        setTimeout(readOnce, POLL_DELAY_MS);
      }
    }
  }

  // Arrancamos el bucle automÃ¡ticamente
  readOnce();
  refreshSubmitState();
});
</script>
{% endblock %}
